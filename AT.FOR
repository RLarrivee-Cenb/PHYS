CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C		ATTFC.FOR
C               
C		RJM 09-MAY-1988
C
C	LINK= LINK ATTFC,VAXLINK:VAXLNK1/OPT
C
CCCCCCCCCCCCCCCCCCC
C	REVISIONS
C
C  	7-MAY-1990 accum nos. for doug johnson's "DOUG" program
C	2-JUL-1990 accum nos. for [.ashift]forfile.dat
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
	EXTERNAL VAXLRW  
	EXTERNAL UFO_OPEN
C
	CHARACTER MON(12)*3/
	1'JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT',
	1'NOV','DEC'/,KY*6,A2*2,FNAM*10,FORA,ASC,KD*6,LAST(2)*6,AINTV/'1'/
C
C
	CHARACTER FILE*6,BPROC*6,VPROC*6,AAM*2,AAY*1,AAD*2,AZ/'0'/,
	1	CODE(3)*6,ADP(368)*6,DATT*6,TD(3)*7/'TXA2:','LTA015:'
	1,'LTA016:'/
	1	,FLD(3)*11,AS,AD*23,
	1 MNTH(12)*3/'JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG',
	1 	'SEP','OCT','NOV','DEC'/
C
	REAL DATA(7,3,31)
C
	INTEGER	FC,BA,BD,CPR,NR,STAT,FLAGS/1/,STATUS,NS,NH,jdat(2),MQ(8)
C
C
	INTEGER*2 TDATA(7),STD(7),STD6(7),FILD(7)
C
C
	DOUBLE PRECISION CT(18),FT(18),SCREEN(14,3,2,5),COMP(2,3,2,5),
	1		 SIL(3,5),FILT2(5,3),BL2,FILT3(5,3),BL3,
	1		 SCR(14,4,5),COMPT(2,4,5),CNT,WAV(9),WAV3(9),  
	1		 OIC2(150),OIC3(150),F2A(6,4),F3A(6,4),
	1		 SILA(4,5),QQ,RR,SS,DP(19),DX(8),AC,AC2,AC3,AC4,
	1		 CM,CM2,CM3,CMS(5),CM2S(5),CM3S(5),M4D(12,5,7),
	1		 MC(5),CAB(2,3,5),CABA(2,4,5),FA2,FA3,FLUXG,
	1		 FCA(2,3),FMG(2,3),FAL(2,3),FSI(2,3),PF,PF3,
	1		 WJT(9,3,5),
	1		 DVJ(7,3,2,31),DVJT(7,3,5),DN,DSM,T1,T2,TS,TA(2),
	1		 ASUM,AN
C
C
	INTEGER DAT(2),IS,IS2,IS3,DAT2(2),DAT3(2),DIFF(2),DIFF2(2),
	1	RECNO,M4DAT(2),INTV(2),DAT6(2),DD3(2),RPDAT(2),BX(2)
                                                 
C
	CHARACTER FIL(4)*21/'USER_D:[METREP]AMBOIC','USER_D:[METREP]BMHOIC',
	1		    'USER_D:[METREP]AMICON','USER_D:[METREP]BMICON'/,
	1	DATJ*4/'.DAT'/,FNB*40,FNH*40,TIMBUF*23,TIMP*23
	1	,AL(4)/'1','2','3','4'/,DP6*1/'6'/
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
	STRUCTURE /FOREMAN/
C
		CHARACTER DATE*6        ! KEY 0  DATE (YYMMDD)
C
C
C     	from shift.for
C
		CHARACTER  NAME(3,2)*10	! names by shift
		REAL TONS(5,3)          ! pellet tons
		REAL TIME(5,3)          ! grate hours
		CHARACTER FA(5,3)	! F=FLUX, A=ACID
		REAL MBTU(5,3)          ! btus/ton
		REAL BENT(5,3)          ! bent. lbs/ton
C
C
C	from met_p:attfc.for
C
		REAL BT(5,3)   		! before tumble +1/4
		REAL AT(5,3)    	! after tumble +1/4
		REAL COMP(5,3)          ! compression
		REAL PBA(5,3)           ! pellet b/a
		REAL PSIL(5,3)		! pellet sio2
		REAL FCR(2,3)           ! filter cake ratio
C
	END STRUCTURE
C
	RECORD /FOREMAN/ FOR
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C
	INCLUDE 'MET_P:MATERIAL.FOR'	! flux or acid check
	CALL SYS$BINTIM (AINTV,INTV) !convert 24 hr interval to binary
C
	OPEN (UNIT=29,FILE='MET_P:ATTINFO.DAT',FORM='UNFORMATTED',
	1	STATUS='UNKNOWN')
	READ (29) IFIL,IREC
	JFIL=0
C
	REWIND (29)
C
	WRITE (29) JFIL,JFIL
	CLOSE (29)
C
cccccccccccccccccccccccccccccccccc
c
C
	OPEN (88,FILE='MET_P:SCREENXX.DAT',FORM='UNFORMATTED',
	1	ACCESS='KEYED',STATUS='old',RECL=2000,
	1	ORGANIZATION='INDEXED',KEY=(1:6:CHARACTER),shared)
C
C
C
	READ (88,KEYGT='000000',IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1			    	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM                         
C
C
c
C		find latest date
C
76	READ (88,IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1		 	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM                         
c
	IF (MMM .EQ. 0) GO TO 76                                  

cccccccccccccccccccccccccccccccccc
C
	if (irec .eq. 2) then
c
c		get the second newest file
c
C
		AD(7:11)='-19'//KD(1:2)
		READ (KD(3:4),'(I2)')MV
		AD(3:6)='-'//MNTH(MV)
		AD(1:2)=KD(5:6)
		ad(12:23)='            '
C
		CALL SYS$BINTIM (AD,BX)
		CALL LIB$SUB_TIMES (BX,INTV,BX)
		CALL SYS$ASCTIM (,AD,BX,)
		IF (AD(1:1) .EQ. ' ') AD(1:1)='0'
C
		DO 91 I=1,12           
			IF (MNTH(I) .EQ. AD(4:6)) GO TO 4191
91		CONTINUE
C
C
		STOP ' MONTH ERROR'
C
4191		WRITE (KY(3:4),'(I2)') I
		IF (KY(3:3) .EQ. ' ') KY(3:3)='0'
C
		
		KY(1:2)=AD(10:11)
		KY(5:6)=AD(1:2)
C
	READ (88,KEY=KY,IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1		 	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM                         
c
C
C
	IF ((IFIL .EQ. 0) .AND. (IREC .EQ. 2)) THEN
C
		RECNO=2
C
		NH=2	!FOR WJB                        
C
		GO TO 811
C
	END IF
c
C
	IF ((IFIL .EQ. 1) .AND. (IREC .EQ. 2)) STOP ' IFIL=1, IREC=2'
C
	end if
C
ccccccccccccccccccccccccccccccccccccccccccccccc
c
c
c
C
C
C
C
C
	RECNO=1
C
C
		NH=IH
		NS=IS
C
c
c
c
cccccccccccccccccccccccc    is it end of day?  ccccccccccccccccccc
c
c
c
c
	if ((is .eq. 3) .and. (ih .eq. 2)) then
C
	GO TO 811
CCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		routine to save 4 hour data for mr. ray potts
C
C
	GO TO 1728
C
	OPEN (UNIT=49,FILE='MET_P:AGGL4HRDATA2.DAT',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',RECL=2000,STATUS='UNKNOWN',
	1	ORGANIZATION='SEQUENTIAL',INITIALSIZE=469,
	1	SHARED,USEROPEN=UFO_OPEN)
C
	READ (49,REC=1,ERR=282) RPDAT
C
	FA2=2                 	!check both sides and see if they're
	FA3=2                   !acid or flux
	IF (FTNFFB) FA2=1
	IF (FTNFFH) FA3=1
C
	IF ((DAT(1).EQ.RPDAT(1)).AND.(DAT(2).EQ.RPDAT(2))) THEN
C
C
C
282		WRITE (49,REC=1)DAT,IS,IH,SCREEN,COMP,CAB,SIL,FILT2,
	1				FILT3,FA2,FA3
C
	ELSE
C
		DO 88 MM=60,2,-1
C
C
		READ (49,REC=MM-1,ERR=88)
	1			DAT,IS,IH,SCREEN,COMP,CAB,SIL,FILT2,
	1				FILT3,BL2,BL3
C
C
		WRITE (49,REC=MM,ERR=88)
	1			DAT,IS,IH,SCREEN,COMP,CAB,SIL,FILT2,
	1				FILT3,BL2,BL3
C
88		CONTINUE
C
C
C
C
C
393	READ (88,KEY=KY,IOSTAT=MMM) KD,DAT,IS,IH,SCREEN,COMP,
	1		 	    CAB,SIL,FILT2,
	1			    FILT3,BL2,BL3,FLUXG,FCA,FMG,FAL,FSI,   
	1			    PA,PC,PM                         
c
C
		WRITE (49,REC=1)DAT,IS,IH,SCREEN,COMP,CAB,SIL,FILT2,
	1				FILT3,FA2,FA3,FLUXG,FCA,FMG,FAL,FSI
C
C
		CLOSE (49)
C
	END IF
C
C
C
	END IF
C                                                     
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
1728	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
C
C	  open doug johnson file, 7 nos. a shift for 31 days
C
	OPEN (UNIT=22,FILE='MET_P:DVJ.DAT',FORM='UNFORMATTED',
	1	ACCESS='DIRECT',RECL=3000,STATUS='UNKNOWN',
	1	ORGANIZATION='SEQUENTIAL')
CCC	1	SHARED,USEROPEN=UFO_OPEN)
C
	read (22,REC=1) jdat	!date of last entry
	READ (22,REC=2) DVJ
C
	IF ((JDAT(1) .NE. DAT(1)) .OR. (JDAT(2) .NE. DAT(2))) THEN
C
		JDAT(1)=DAT(1)
		JDAT(2)=DAT(2)
C
		WRITE (22,REC=1) JDAT
C
C
C
C		  roll data down one day
C
		DO 161 I=2,31
		DO 161 J=1,3
		DO 161 K=1,2
		DO 161 L=1,7
C
161			DVJ(L,J,K,I-1)=DVJ(L,J,K,I)
C
C
C		  zero out latest day
C
		DO 722 J=1,3
		DO 722 K=1,2
		DO 722 L=1,7
722			DVJ(L,J,K,31)=0.
	END IF
C
C
	END IF
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C	average screen fractions for all 3 shifts
C
811	CALL SYS$ASCTIM(,TIMBUF,DAT,)	!convert file date to ascii
C
	CALL SYS$ASCTIM(,TIMP,,)	!put present time in TIMP
C
C
	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
CCCCCCCCCCCCCCC
C
C		open agglom. foreman file on 2nd half of each shift
C
	LV=0
C
9879	OPEN   (UNIT=50,FILE='USER_D:[METREP.ASHIFT]FORFILE.DAT',
	1	STATUS='UNKNOWN',ORGANIZATION='INDEXED',ACCESS='KEYED',
	1	FORM='UNFORMATTED',RECL=256,KEY=(1:6:CHARACTER),
	1	ERR=5151)
C
	GO TO 5152
C
CCCCCCCCCCCCCCC
C
C
5151	LV=LV+1
	IF (LV .GT. 300) THEN
		WRITE (6,*) ' FORFIL.DAT IS LOCKED, CALL RJM @ 7490'
		CALL LIB$WAIT(5.)
		GO TO 812
	END IF
C
	CALL LIB$WAIT (1.)
	GO TO 9879
C
C
CCCCCCCCCCCCCCC
5152		DO 3737 MM=1,12
			IF (MON(MM) .EQ. TIMBUF(4:6)) GO TO 1108
3737		CONTINUE
		GO TO 812
C
C
1108		WRITE (A2, '(I2)')MM
		IF (MM .LT. 10) A2='0'//A2(2:2)
		IF (TIMBUF(1:1) .EQ. ' ')TIMBUF(1:1)='0'
C
		KY=TIMBUF(10:11)//A2//TIMBUF(1:2)
C
		READ (50,KEY=KY,IOSTAT=LLX,ERR=7272) FOR
C
7272		CONTINUE
C
	END IF
C
CCCCCCCCCCCCCCC
C
C
C
812	DO 1800 LN=1,5
C
	DO 1800 ISH=1,3
C
	AC=0
	AC2=0
	AC3=0
	AC4=0
C
	DO 1800 IT=1,8
C
	IF (IT .EQ. 8) GO TO 911
C
	ITX=IT+7
	AC=AC+SCREEN(IT,ISH,1,LN)
	AC2=AC2+SCREEN(ITX,ISH,1,LN)
	AC3=AC3+SCREEN(IT,ISH,2,LN)
	AC4=AC4+SCREEN(ITX,ISH,2,LN)
C
C
C
1799	CONTINUE
C
1800	CONTINUE
C
C
C
	GO TO 2424
C
C
C
911	DO 912 ITA=1,7
C
	ITB=ITA+7
	IF (AC .EQ. 0) THEN
	SCREEN(ITA,ISH,1,LN)=0
	ELSE		
	SCREEN(ITA,ISH,1,LN)=100.*SCREEN(ITA,ISH,1,LN)/AC
	END IF
C
	IF (AC2 .EQ. 0) THEN		
	SCREEN(ITB,ISH,1,LN)=0
	ELSE
	SCREEN(ITB,ISH,1,LN)=100.*SCREEN(ITB,ISH,1,LN)/AC2
	END IF
C
	IF (AC3 .EQ. 0) THEN
	SCREEN(ITA,ISH,2,LN)=0
	ELSE
	SCREEN(ITA,ISH,2,LN)=100.*SCREEN(ITA,ISH,2,LN)/AC3
	END IF
C
	IF (AC4 .EQ. 0) THEN
	SCREEN(ITB,ISH,2,LN)=0
	ELSE
	SCREEN(ITB,ISH,2,LN)=100.*SCREEN(ITB,ISH,2,LN)/AC4
	END IF
C
912	CONTINUE 
C
	GO TO 1799
C
C
C
C
2424	DO 100 LN=1,5
C
	DO 100 ISH=1,3
C
	DO 100 IT=1,14
C
C
	CNT=0
	IF (SCREEN(3,ISH,1,LN) .NE. 0) CNT=CNT+1.
	IF (SCREEN(3,ISH,2,LN) .NE. 0) CNT=CNT+1.
C
	IF (CNT .EQ. 0) GO TO 100
C
	SCR(IT,ISH,LN)=(SCREEN(IT,ISH,1,LN)+SCREEN(IT,ISH,2,LN))/CNT
C
C
100	CONTINUE
C                                    
C
	DO 120 LN=1,5
	DO 120 IT=1,14
C
	CNT=0.
C
	IF (SCR(IT,1,LN) .NE. 0) CNT=CNT+1.
	IF (SCR(IT,2,LN) .NE. 0) CNT=CNT+1.
	IF (SCR(IT,3,LN) .NE. 0) CNT=CNT+1. 
C
	IF (CNT .EQ. 0) GO TO 120
C
	SCR(IT,4,LN)=(SCR(IT,1,LN)+SCR(IT,2,LN)+SCR(IT,3,LN))/CNT
C
120	CONTINUE
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		get average compressions for all 3 shifts
C
C
	DO 200 LN=1,5
C
	DO 200 ISH=1,3
C
	DO 200 IT=1,2
C
C
	CNT=0
	IF (COMP(IT,ISH,1,LN) .NE. 0) CNT=CNT+1.
	IF (COMP(IT,ISH,2,LN) .NE. 0) CNT=CNT+1.
C
	IF (CNT .EQ. 0) GO TO 200
C
	COMPT(IT,ISH,LN)=(COMP(IT,ISH,1,LN)+COMP(IT,ISH,2,LN))/CNT
C
C
200	CONTINUE     
C
C
	DO 220 LN=1,5
	DO 220 IT=1,2
C
	CNT=0.
C       
	IF (COMPT(IT,1,LN) .NE. 0) CNT=CNT+1.
	IF (COMPT(IT,2,LN) .NE. 0) CNT=CNT+1.
	IF (COMPT(IT,3,LN) .NE. 0) CNT=CNT+1. 
C
	IF (CNT .EQ. 0) GO TO 220
C
	COMPT(IT,4,LN)=(COMPT(IT,1,LN)+COMPT(IT,2,LN)+COMPT(IT,3,LN))/CNT
C
220	CONTINUE
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C	average sio2
C
C
	DO 300 LN=1,5
C
C
	SILA(1,LN)=SIL(1,LN)
	SILA(2,LN)=SIL(2,LN)
	SILA(3,LN)=SIL(3,LN)
	CNT=0.
C
	IF (SIL(1,LN) .NE. 0) CNT=CNT+1.
	IF (SIL(2,LN) .NE. 0) CNT=CNT+1.
	IF (SIL(3,LN) .NE. 0) CNT=CNT+1.
C
	IF (CNT .EQ. 0) GO TO 300
C
	SILA(4,LN)=(SIL(1,LN)+SIL(2,LN)+SIL(3,LN))/CNT
C
C
300	CONTINUE
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	CAO/MGO & B/A
C
	DO 991 I=1,3
	DO 991 J=1,5
	CABA(1,I,J)=CAB(1,I,J)
991	CABA(2,I,J)=CAB(2,I,J)
C
	DO 820 LN=1,5
	DO 820 IT=1,2
C
	CNT=0.
C       
	IF (CABA(IT,1,LN) .NE. 0) CNT=CNT+1.
	IF (CABA(IT,2,LN) .NE. 0) CNT=CNT+1.
	IF (CABA(IT,3,LN) .NE. 0) CNT=CNT+1. 
C
	IF (CNT .EQ. 0) GO TO 820
C
	CABA(IT,4,LN)=(CABA(IT,1,LN)+CABA(IT,2,LN)+CABA(IT,3,LN))/CNT
C
820	CONTINUE
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		convert filter ca,mg,al,si to ca/mg and b/a
C
	DO 388 MM=1,3
		IF (FMG(1,MM) .LE. 0) GO TO 508
		FILT2(4,MM)=FCA(1,MM)/FMG(1,MM)
508		IF ((FAL(1,MM)+FILT2(1,MM)) .LE. 0) GO TO 509
		FILT2(5,MM)=(FCA(1,MM)+FMG(1,MM))/(FAL(1,MM)+FILT2(1,MM))
509		IF (FMG(2,MM) .LE. 0) GO TO 510
		FILT3(4,MM)=FCA(2,MM)/FMG(2,MM)
510		IF ((FAL(2,MM)+FILT3(1,MM)) .LE. 0) GO TO 388
		FILT3(5,MM)=(FCA(2,MM)+FMG(2,MM))/(FAL(2,MM)+FILT3(1,MM))
388	CONTINUE
C
C
C	filter data
C
	DO 4040	LQ=1,3
C
	IF ((FCA(1,LQ).LE.0) .OR. (FMG(1,LQ).LE.0)) GO TO 4039
		F2A(6,LQ)=((FCA(1,LQ)+FMG(1,LQ))-.6)/.5377
		F2A(6,LQ)=F2A(6,LQ)/(100.-F2A(6,LQ))
4039	IF ((FCA(2,LQ).LE.0) .OR. (FMG(2,LQ).LE.0)) GO TO 4040
		F3A(6,LQ)=((FCA(2,LQ)+FMG(2,LQ))-.6)/.5377
		F3A(6,LQ)=F3A(6,LQ)/(100.-F3A(6,LQ))
4040	CONTINUE
C
	DO 400 IT=1,6
C
	IF (IT .EQ. 6) GO TO 19
	F2A(IT,1)=FILT2(IT,1)
	F2A(IT,2)=FILT2(IT,2)
	F2A(IT,3)=FILT2(IT,3)
	F3A(IT,1)=FILT3(IT,1)
	F3A(IT,2)=FILT3(IT,2)
	F3A(IT,3)=FILT3(IT,3)
C
19	CNT=0.
	IF (F2A(IT,1) .NE. 0) CNT=CNT+1.
	IF (F2A(IT,2) .NE. 0) CNT=CNT+1.
	IF (F2A(IT,3) .NE. 0) CNT=CNT+1.
C
	IF (CNT .EQ. 0) GO TO 501
C
	F2A(IT,4)=(F2A(IT,1)+F2A(IT,2)+F2A(IT,3))/CNT
C
C
501	CNT=0.
	IF (F3A(IT,1) .NE. 0) CNT=CNT+1.
	IF (F3A(IT,2) .NE. 0) CNT=CNT+1.
	IF (F3A(IT,3) .NE. 0) CNT=CNT+1.
C
	IF (CNT .EQ. 0) GO TO 400
C
	F3A(IT,4)=(F3A(IT,1)+F3A(IT,2)+F3A(IT,3))/CNT
C
C
400	CONTINUE
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C	OUTPUT DEVICE
C
	OPEN (UNIT=61,FILE='MET_P:SFIL.LIS',STATUS='UNKNOWN',
	1	SHARED,USEROPEN=UFO_OPEN)
C
	OPEN (UNIT=62,FILE='VAXLINK:ATTDAT.LNK',ACCESS='SEQUENTIAL',RECL=114
	1      ,RECORDTYPE='FIXED',STATUS='UNKNOWN')
C
	GO TO 6722
C
6399	STOP
C
6722	JDE=1
	IF (IFIL .EQ. 1) JDE=2
C
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
	DO 797 IDEV=1,JDE    
C
	IF (IDEV .GT. 1) THEN
C
	IDX=IDEV
C
	IF (RECNO .EQ. 2) IDX=3	!send output to txa3: if it's end of day
C
	OPEN (UNIT=6,FILE=TD(IDX),STATUS='UNKNOWN',
	1	CARRIAGECONTROL='FORTRAN',ERR=744)
C
	GO TO 259
C
C		open alternate device if one is failed
c
744	IF (IDX .EQ. 2) THEN
		IDX=3
	ELSE
		IDX=2
	END IF
C
	OPEN (UNIT=6,FILE=TD(IDX),STATUS='UNKNOWN',
	1	CARRIAGECONTROL='FORTRAN',ERR=745)
C
	GO TO 259
C
745	WRITE (6,*) '  '
C
	END IF
C
259	CALL LIB$SPAWN('SET TERM/WIDTH=132')
C
3401	JJCNT=0
C
	IF (RECNO .EQ. 2) THEN
C                                              
		I1=IS
		I2=IH
C
	ELSE
C
		I1=IS
		I2=IH
C
	END IF
C
C
401	WRITE (6,2001,ERR=588) TIMP(1:17),TIMBUF(1:11),I1,I2
2001	FORMAT ('1',33X,'AGGLOMERATOR PELLET 
	1AND FILTER CAKE DATA REPORT',5X,'RUN ON: ',
	1A17//' ',45X,'REPORT FOR: ',A11,17X,
	1'THRU: SHIFT ',I1,'  HALF ',I1)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2001) TIMP(1:17),TIMBUF(1:11),I1,I2
	END IF
C
	IF (TIMBUF(1:1) .EQ. ' ')TIMBUF(1:1)='0'
C
C                                              
C                                              
C
C
	DO 3000 LIN=1,5               
C
C
C
C
	IF (LIN .EQ. 1) THEN
C
191	FORMAT (' ')
C
	WRITE (6,191,ERR=588)
	WRITE (6,191,ERR=588)
	WRITE (6,191,ERR=588)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,191)
	WRITE (61,191)
	WRITE (61,191)
	END IF
C
	WRITE (6,2002,ERR=588)
2002	FORMAT ('    **      BEFORE TUMBLE     ** ***      AFTER TUMBLE
	1      **   CUMULATIVE +1/4   COMPRESSION       * PELLET *')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2002)
	END IF
C
	IF (FTNFFB) GO TO 887
C
86	WRITE (6,191,ERR=588)
	WRITE (6,2203,ERR=588)
2203	FORMAT (' *** SPECIFICATIONS ***    054 GRADE ACID PELLETS')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2003)
	END IF
C
	WRITE (6,2204,ERR=588)
2204	FORMAT (' MX/MN   <10',46X,'<3.0  >97.5 >95.0',9X,'>450  <7.0'
	1,13X,'>5.04 <5.76')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2004)
	END IF
C
	WRITE (6,2205,ERR=588)
2205	FORMAT (' MEAN    7.5',47X,'2.5   98.5  97.0',10X,'500  <5.0',
	1	14X,'5.40')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2005)
	END IF
C
	WRITE (6,2206,ERR=588)
2206	FORMAT ('     +    +    +    +    +    -    +    +    +    +
	1   +    -')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2006)
	END IF
C
	WRITE (6,2007,ERR=588)
C2207	FORMAT ('    5/8  1/2  3/8  1/4  28M  28M  5/8  1/2  3/8  1/4
C	1  28M  28M   B.T.  A.T.  Q IN   AVG  <200                SIO2')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2007)
	END IF
C
C
	IF (LIN .EQ. 4) GO TO 712
C                
C
	END IF
C
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
	IF (LIN .EQ. 4) THEN
C
C
	IF (FTNFFB .AND. FTNFFH) GO TO 712
	IF ((.NOT. FTNFFB) .AND. (.NOT. FTNFFH)) GO TO 712
C
	IF (.NOT. FTNFFH) GO TO 86
C
C
C
	WRITE (6,191,ERR=588)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,191)
	END IF
C
	WRITE (6,2002,ERR=588)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2002)
	END IF
C
887	WRITE (6,191,ERR=588)
	WRITE (6,2003,ERR=588)
2003	FORMAT (' *** SPECIFICATIONS ***    060 GRADE FLUX PELLETS')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2003)
	END IF
C
	WRITE (6,2004,ERR=588)
2004	FORMAT (' MX/MIN  <15',46X,'<4.0  >97.0 >94.0',9X,'>420  <8.0'
	1,6X,'1.31/.89',' 3.64/4.36')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2004)
	END IF
C
	WRITE (6,2005,ERR=588)
2005	FORMAT (' MEAN     10',47X,'3.0   98.0  96.0',10X,'460  <6.0',
	1	8X,'1.10',3X,'4.00')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2005)
	END IF
C
	WRITE (6,2006,ERR=588)
2006	FORMAT ('     +    +    +    +    +    -    +    +    +    +
	1   +    -')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2006)
	END IF
C
	WRITE (6,2007,ERR=588)
2007	FORMAT (' ',95X,'CAO/'/' ',
	1'   5/8  1/2  3/8  1/4  28M  28M  5/8  1/2  3/8  1/4
	1  28M  28M   B.T.  A.T.  Q IN   AVG   <200  MGO    B/A   SIO2')
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2007)
	END IF
C
C
C
C
C
C
C
	END IF
C
C
C
C
712	WRITE (6,2008,ERR=588)LIN+2
2008	FORMAT ('0LINE ',I1)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2008)LIN+2
	END IF
C
	DO 3000 ISH=1,4
C
C
	QQ=
	1	((100.-SCR(5,ISH,LIN)-SCR(6,ISH,LIN)-SCR(7,ISH,LIN))*
	1	(100.-SCR(12,ISH,LIN)-SCR(13,ISH,LIN)-SCR(14,ISH,LIN)))/100.
C
	RR=	100.-SCR(5,ISH,LIN)-SCR(6,ISH,LIN)-SCR(7,ISH,LIN)
C
	SS=	100.-SCR(12,ISH,LIN)-SCR(13,ISH,LIN)-SCR(14,ISH,LIN)
C
	IF (QQ .GE. 100.)QQ=0.
	IF (RR .GE. 100.)RR=0.
	IF (SS .GE. 100.)SS=0.
C
C
C
C
C
	IF (ISH .EQ. 4) THEN
		CM=CMS(LIN)
		CM2=CM2S(LIN)
		CM3=CM3S(LIN)
		GO TO 555
	END IF
C
C
	IF (COMP(1,ISH,2,LIN) .EQ. 0) THEN
		IF (COMP(1,ISH,1,LIN) .EQ. 0) THEN
			CM=0
			CM2=0
			GO TO 555
C
		ELSE
C
			CM=COMP(1,ISH,1,LIN)
			CM2=COMP(2,ISH,1,LIN)
		END IF
C
	ELSE
C
	CM=COMP(1,ISH,2,LIN)
	CM2=COMP(2,ISH,2,LIN)
C
	END IF
C
C
	IF (CM .NE. 0) THEN
C               
		CMS(LIN)=CM
		CM2S(LIN)=CM2
C                   
	END IF
C
C
C
C		save b.t.+1/4 for bill babich
C
	IF (ISH .NE. 4) THEN
C
		IF (NH .EQ. 2) THEN
C
			IF (RR .GE. 100) GO TO 555
C
	WJT(1,ISH,LIN)=SCR(1,ISH,LIN)+SCR(2,ISH,LIN)		!BT +1/2
	WJT(2,ISH,LIN)=RR					!BT +1/4
	WJT(3,ISH,LIN)=100.-SCR(6,ISH,LIN)+SCR(7,ISH,LIN)	!BT +4M
	WJT(4,ISH,LIN)=SS                                       !AT +1/4
	WJT(5,ISH,LIN)=SCR(14,ISH,LIN)                          !-28M
	WJT(6,ISH,LIN)=CM                                       !COMPRESSION
	WJT(7,ISH,LIN)=CM2                                      !COMP. -200 
	WJT(8,ISH,LIN)=SILA(ISH,LIN)				!PEL. SIO2
	WJT(9,ISH,1)=F2A(1,ISH)					!S 2 FILT SIO2
	WJT(9,ISH,2)=F3A(1,ISH)					!S 3 FILT SI02
C
C
		END IF
	END IF
C
C
555	WRITE (6,2009,ERR=588)AL(ISH),(SCR(M,ISH,LIN),M=1,4),
	1	SCR(5,ISH,LIN)+SCR(6,ISH,LIN),SCR(7,ISH,LIN),
	1	(SCR(M,ISH,LIN),M=8,11),
	1	SCR(12,ISH,LIN)+SCR(13,ISH,LIN),SCR(14,ISH,LIN),
	1	RR,SS,QQ,
	1	CM,CM2,(CABA(JA,ISH,LIN),JA=1,2),SILA(ISH,LIN)
C
2009	FORMAT (' ',A1,12F5.1,1X,3F6.1,3X,F4.0,2X,F4.1,2X,F4.2,F6.2,F7.2)
C
C
C	  	collect dvj data
C
	IF (ISH .NE. 4) THEN
C
		IF (NH .EQ. 2) THEN
C
			DVJT(1,ISH,LIN)=SCR(1,ISH,LIN)+SCR(2,ISH,LIN)
			DVJT(2,ISH,LIN)=SCR(5,ISH,LIN)+SCR(4,ISH,LIN)+
	1	SCR(3,ISH,LIN)+SCR(2,ISH,LIN)+SCR(1,ISH,LIN)
			DVJT(3,ISH,LIN)=SCR(14,ISH,LIN)
			DVJT(4,ISH,LIN)=RR
			DVJT(5,ISH,LIN)=SS
			DVJT(6,ISH,LIN)=CM
			DVJT(7,ISH,LIN)=CM2
C
C
C
C
C
		IF (IFIL .NE. 1) GO TO 1107
C
CCCCCCCCC
C
C		collect [.ashift]forfile.dat data
C
		IF (LLX .EQ. 0) THEN
C
		FOR.BT(LIN,ISH)=RR	
		FOR.AT(LIN,ISH)=SS
		FOR.COMP(LIN,ISH)=CM
		FOR.PBA(LIN,ISH)=CABA(2,ISH,LIN)
		FOR.PSIL(LIN,ISH)=SILA(ISH,LIN)
		FOR.FCR(1,ISH)=F2A(6,ISH)
		FOR.FCR(2,ISH)=F3A(6,ISH)
C
C
C
		END IF
C   
		END IF
C
	END IF
C                       
C
1107	IF (IDEV .EQ. 1) THEN
C
C		save data to send to bmg
C
	WRITE (62,2099)(SCR(M,ISH,LIN),M=1,4),
	1	SCR(5,ISH,LIN)+SCR(6,ISH,LIN),SCR(7,ISH,LIN),
	1	(SCR(M,ISH,LIN),M=8,11),
	1	SCR(12,ISH,LIN)+SCR(13,ISH,LIN),SCR(14,ISH,LIN),
	1	RR,SS,QQ,
	1	CM,CM2,CM3,SILA(ISH,LIN)
C
2099	FORMAT (12F6.1,3F6.1,F6.0,F6.1,F6.0,F6.2)
C
	END IF
C
C
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,2009)AL(ISH),(SCR(M,ISH,LIN),M=1,4),
 	1	SCR(5,ISH,LIN)+SCR(6,ISH,LIN),SCR(7,ISH,LIN),
	1	(SCR(M,ISH,LIN),M=8,11),
	1	SCR(12,ISH,LIN)+SCR(13,ISH,LIN),SCR(14,ISH,LIN),
	1	RR,SS,QQ,
	1	CM,CM2,(CABA(JA,ISH,LIN),JA=1,2),SILA(ISH,LIN)
C
	END IF
C
C
C
C
3000	CONTINUE
C
C
CCCCCCCCCCCCCCCCCCCC
C
C	write out forfile.dat data
C
	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
C
		IF (LLX .EQ. 0) REWRITE (50,ERR=9091) FOR
C
		CLOSE (50)
C
	END IF
C
CCCCCCCCCCCCCCCCCCCC
C
9091	WRITE (6,3001,ERR=588)
3001	FORMAT (//'0','FILTER CAKE',13X,'STEP 2',21X,'FLUX',15X,'STEP 3',
	1 34X,'FLUX',3X,'FLUX STONE'/' ',6X,
	1' SIO2   -270   -500  BLAINE  CAO/MGO   B/A','   RATIO',10X
	1,'SIO2   -270   -500  BLAINE  CAO/MGO   B/A','   RATIO',5X,'% -200M') 
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,3001)
	END IF
C
	DO 4000 ISH=1,4  
C
	IF (ISH .NE. 4) THEN
C
	WRITE (6,3002,ERR=588)AL(ISH),(F2A(M,ISH),M=1,6),(F3A(M,ISH),M=1,6)
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,3002)AL(ISH),(F2A(M,ISH),M=1,6),(F3A(M,ISH),M=1,6)
	WRITE (62,3003) (F2A(M,ISH),M=1,3),(F3A(M,ISH),M=1,3)
	END IF
C
3002	FORMAT (' ',A1,3X,3F7.2,10X,2F7.2,F7.4,7X,3F7.2,10X,2F7.2,F7.4)
3003	FORMAT (2(3F6.2,6X),66X)
C
	ELSE
C
	WRITE (6,3022,ERR=588)AL(ISH),(F2A(M,ISH),M=1,3),BL2,
	1	(F2A(M,ISH),M=4,6),(F3A(M,ISH),M=1,3),BL3,(F3A(M,ISH),M=4,6)
	1	,FLUXG                                  
C
	WRITE (6,3099,ERR=588)
3099	FORMAT ('1')
C
C
	IF (IDEV .EQ. 1) THEN
	WRITE (61,3022)AL(ISH),(F2A(M,ISH),M=1,3),BL2,
	1	(F2A(M,ISH),M=4,6),(F3A(M,ISH),M=1,3),BL3,(F3A(M,ISH),M=4,6)
	1	,FLUXG
	WRITE (61,3099)
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
CCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCC
C	PATCH PATCH PATCH
	STOP
CCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCC
C
C
	IF (IFIL .EQ. 1) THEN
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	  collect data for spc charts
C
C
CC	STATUS=LIB$SPAWN ('RUN USER_D:[METREP.GKS]LABDAT42')
CC	STATUS=LIB$SPAWN ('SUBMIT/NOLOG USER_D:[METREP.GKS]SPC.COM')
CC	STATUS=LIB$SPAWN ('SUBMIT/NOLOG USER_D:[METREP.GKS]SPC3.COM')
CC	IF (.NOT. STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
	END IF
C
C
C
C
C	close out doug's data
C
	IF ((IFIL .EQ. 1) .AND. (NH .EQ. 2)) THEN
C
C         steps 1 & 2
C
	DO 499 KS=1,3	!shift
	DO 499 I=1,7    !data
		DN=0
		DSM=0
		DO 498 J=1,3    !lines
C
			IF (DVJT(I,KS,J) .LE. 0) GO TO 498
C
			DN=DN+1
			DSM=DSM+DVJT(I,KS,J)
C
498		CONTINUE
C
		IF (DN .GT. 0) DVJ(I,KS,1,31)=DSM/DN
C
499	CONTINUE
C
C
C         steps 3
C
	DO 3499 KS=1,3	!shift
	DO 3499 I=1,7    !data
		DN=0
		DSM=0
		DO 3498 J=4,5    !lines
C
			IF (DVJT(I,KS,J) .LE. 0) GO TO 3498
C
			DN=DN+1
			DSM=DSM+DVJT(I,KS,J)
C
3498		CONTINUE
C
		IF (DN .GT. 0) DVJ(I,KS,2,31)=DSM/DN
C
3499	CONTINUE
C
C
	WRITE (22,REC=2) DVJ
C
	CLOSE (22)
C
C
	END IF
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	send float sio2 and grind across link to 1353000,B,BMG
C
	OPEN (UNIT=89,FILE='MET_P:FLOAT',RECL=20,FORM='UNFORMATTED',
	1RECORDTYPE='FIXED',STATUS='UNKNOWN')
C	,SHARED,USEROPEN=UFO_OPEN)
C
	READ (89,ERR=477) FS,F2
C
477	CLOSE (89)
C
	WRITE (62,3023) (F2A(M,ISH),M=1,3),BL2,(F3A(M,ISH),M=1,3),BL3,FS,F2
C
	END IF
C                              
3022	FORMAT (' ',A1,3X,2(3F7.2,F6.0,4X,2F7.2,F7.4,7X),F5.2)
3023	FORMAT (3F6.2,F6.0,3F6.2,F6.0,2F6.2,54X)
C
C
	END IF        
C
4000	CONTINUE
C
	CLOSE (6)
C
797	CONTINUE
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C                       
C
6014	IF (IFIL .NE. 1) THEN
	WRITE (6,*) ' '
	CALL LIB$SPAWN ('SET TERM/WIDTH=80')	
		STOP
	END IF                                           
C             
C	IF (IFIL .EQ. 1) THEN  !request from metinput if ifil=1
C
C		JJCNT=JJCNT+1
C                     
C		IF (JJCNT .EQ. 2) GO TO 654
C       
		CLOSE (61)
C
C		GO TO 401
C
C	ELSE
C
C		STOP
C
C	END IF
C
C
C	SECTION TO SEND DATA TO BMH VIA TERM. SERVER
C
	WRITE (6,2822)
2822	FORMAT('0SENDING DATA TO STEP 3 AGGLOM, PLEASE WAIT')
C
C
654	STATUS=LIB$SPAWN ('PRINT/QUE=BMHPRINT USER_D:[METREP]SFIL.LIS',
	1,,FLAGS,,,,,,,,)
C
	IF (.NOT. STATUS) CALL LIB$SIGNAL(%VAL(STATUS))
C
C
C	
	CALL LIB$SPAWN ('SET TERM/WIDTH=80')	
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		section to send bt+1/4 to wjb
C
	IF (NH .EQ. 2) THEN	!see if its second half of shift
C
C
C
		OPEN (UNIT=88,FILE='MET_P:WJBBTX.DAT',STATUS='OLD',
	1	SHARED,USEROPEN=UFO_OPEN)
C
C
	DO 3811 I=1,8
3811	WAV(I)=0.
C
	M=0
	DO 322 LA=1,8
	DO 322 I=1,3
		WAV(LA)=WAV(LA)+WJT(LA,NS,I)
		IF (WJT(LA,NS,I) .GT. 0) MQ(LA)=MQ(LA)+1
322	CONTINUE
C
	DO 729 I=1,8
	IF (MQ(I) .EQ. 0) GO TO 729
C
	WAV(I)=WAV(I)/MQ(I)
729	CONTINUE
C
C
	DO 3812 I=1,8
	MQ(I)=0
3812	WAV3(I)=0.
C
	M=0
	DO 363 LA=1,8
	DO 363 I=4,5
		WAV3(LA)=WAV3(LA)+WJT(LA,NS,I)
		IF (WJT(LA,NS,I) .GT. 0) MQ(LA)=MQ(LA)+1
363	CONTINUE
C
	DO 7729 I=1,8
	IF (MQ(I) .EQ. 0) GO TO 1199
C
	WAV3(I)=WAV3(I)/MQ(I)
7729	CONTINUE
C
	WAV(9)=WJT(9,NS,1)	!ST 2 FILT SIO2
	WAV3(9)=WJT(9,NS,2)	!ST 3 FILT SIO2
C
1199	WRITE (AS,'(I1)')NS	!convert shift to ascii
C
	WRITE (88,255)TIMBUF(1:11),AS,(WAV(I5),I5=1,9),(WAV3(J),J=1,9),FS,F2
255	FORMAT (A11,A1,20F7.2)
C
	CLOSE (88)
C
		CALL LIB$SPAWN ('RUN OREM:BTUMX',,'MET_P:OREMSPAWN.ERR')
C
C
	END IF
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C	put data into daily met report files
C
C
C
	IF (.NOT.((RECNO .EQ. 2) .AND. (IFIL .EQ. 1))) GO TO 621
C                      
C
C
C
	OPEN   (UNIT=10,FILE=FIL(1)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED')
C
	OPEN   (UNIT=11,FILE=FIL(2)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED')
C                    
C
	READ (10,ERR=600)OIC2
C                           
600	READ (11,ERR=601)OIC3
C
601	DO 1000 LN=1,3
C
	N=(LN-1)*10+1
C                                       
	OIC2(N)		=SCR(1,4,LN)+SCR(2,4,LN)
	OIC2(N+1)	=SCR(3,4,LN)
	OIC2(N+2)  	=SCR(4,4,LN)
	OIC2(N+3)	=SCR(5,4,LN)+SCR(6,4,LN)
	OIC2(N+4)	=SCR(7,4,LN)
C
	OIC2(N+5)	=SCR(8,4,LN)+SCR(9,4,LN)
	OIC2(N+6)	=SCR(10,4,LN)
	OIC2(N+7)	=SCR(11,4,LN)
	OIC2(N+8)	=SCR(12,4,LN)+SCR(13,4,LN)
	OIC2(N+9)	=SCR(14,4,LN)
C               
C
1000	CONTINUE
C
C
	OIC2(41) =SCR(5,4,1)
	OIC2(42) =SCR(12,4,1)
	OIC2(113)=SCR(5,4,2)   	! 4 MESH
	OIC2(114)=SCR(5,4,3)
	OIC2(115)=SCR(12,4,2)
	OIC2(116)=SCR(12,4,3)
C
C
C
	OIC2(31)=CMS(1)
	OIC2(32)=CMS(2)
	OIC2(33)=CMS(3)
C
	OIC2(34)=CM2S(1)
	OIC2(35)=CM2S(2)
	OIC2(36)=CM2S(3)
C
CCCC	OIC2(38)=CM3S(1)
CCCC	OIC2(39)=CM3S(2)
C
	OIC2(43)=SILA(4,1)
	OIC2(44)=SILA(4,2)
	OIC2(45)=SILA(4,3)
C
 	OIC2(47)=F2A(1,4)
	OIC2(48)=BL2
	OIC2(49)=F2A(2,4)
	OIC2(50)=F2A(3,4)
C
	OIC2(105)=CABA(1,4,1)
	OIC2(106)=CABA(1,4,2)
	OIC2(107)=CABA(1,4,3)
C
	OIC2(108)=CABA(2,4,1)
	OIC2(109)=CABA(2,4,2)
	OIC2(110)=CABA(2,4,3)
C
	OIC2(111)=F2A(4,4)
	OIC2(112)=F2A(5,4)
C
	REWIND (10)
C
	WRITE (10) OIC2
C
	CLOSE (10)
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
c
C	  bring in steps 1,2 & 3 rmf shift tons
c
c
	OPEN (UNIT=38,FILE='MET_P:SHIFT_RMF.DAT',STATUS='UNKNOWN',
	1	ACCESS='DIRECT',FORM='UNFORMATTED',RECL=4,ERR=908)
C
	TS=0
	TA(1)=0
	TA(2)=0
C
	TRIP=0
	ASUM=0
	AN=0
C
C
	DO 368 N=1,3
		READ (38,REC=N,ERR=908)T1,T2
C
		TS=TS+(T1+T2)
C
		TA(1)=TA(1)+FSI(1,N)*(T1+T2)
		TA(2)=TA(2)+FSI(2,N)*(T1+T2)
C
C
C	  see if there are tons and no flot sio2 or vice-versa
C
		IF (((T1+T2) .LE. 0) .AND. (FSI(1,N) .GT. 0)) TRIP=TRIP+1
		IF (((T1+T2) .GT. 0) .AND. (FSI(1,N) .LE. 0)) TRIP=TRIP+1
C
		IF (FSI(1,N) .GT. 0) THEN
			AN=AN+1.
			ASUM=ASUM+FSI(1,N)
		END IF
368	CONTINUE
C
C
	IF (TS .LE. 0) GO TO 908
C
C
C
	IF (TRIP .EQ. 0) THEN
C
		TA(1)=TA(1)/TS  	! WTD. AVERAGE FLOT SIO2
C
	ELSE
C
		IF (AN .LE. 0) GO TO 908
C
		TA(1)=ASUM/AN		! ARITH. AVG FLOT SIO2
C
	END IF
C
C
C	
	TA(2)=TA(2)/TS          ! AVERAGE FLOT -270
	
908	CLOSE (38)
C
c
c
c
c
C
C	section to open amicon.dat file and put flux -200 in it
c
c
C
	OPEN   (UNIT=10,FILE=FIL(3)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED',ERR=8657)
C
	READ (10,ERR=739)OIC2
C
739	OIC2(115)=FLUXG
	OIC2(99)=TA(1)
	OIC2(100)=TA(2)
C
	REWIND (10)
	WRITE (10)OIC2
	CLOSE (10)
C
C
C
C
C
8657	OPEN   (UNIT=17,FILE=FIL(4)//TIMBUF(1:2)//DATJ,STATUS='UNKNOWN',
	1	FORM='UNFORMATTED',ERR=8658)
C
	READ (17,ERR=7394)OIC2
C
7394	OIC2(56)=TA(1)
	OIC2(57)=TA(2)
C
	REWIND (17)
	WRITE (17)OIC2
	CLOSE (17)
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C		STEP 3
C
C
8658	DO 2000 LN=4,5
C
	N=(LN-4)*10+1
C
	OIC3(N)		=SCR(1,4,LN)+SCR(2,4,LN)
	OIC3(N+1)	=SCR(3,4,LN)
	OIC3(N+2)	=SCR(4,4,LN)
	OIC3(N+3)	=SCR(5,4,LN)+SCR(6,4,LN)
	OIC3(N+4)	=SCR(7,4,LN)
C
	OIC3(N+5)	=SCR(8,4,LN)+SCR(9,4,LN)
	OIC3(N+6)	=SCR(10,4,LN)
	OIC3(N+7)	=SCR(11,4,LN)
	OIC3(N+8)	=SCR(12,4,LN)+SCR(13,4,LN)
	OIC3(N+9)	=SCR(14,4,LN)
C
C
2000	CONTINUE
C
	OIC3(96)=SCR(5,4,4) 	! 4 MESH
	OIC3(97)=SCR(5,4,5)
	OIC3(98)=SCR(12,4,4)
	OIC3(99)=SCR(12,4,5)
C
C
	OIC3(21)=CMS(4)
	OIC3(22)=CMS(5)
C
	OIC3(23)=CM2S(4)
	OIC3(24)=CM2S(5)
C
	OIC3(25)=CM3S(4)
	OIC3(26)=CM3S(5)
C                    
	OIC3(29)=SILA(4,4)
	OIC3(30)=SILA(4,5)
C
	OIC3(32)=F3A(1,4)
8	OIC3(33)=BL3
	OIC3(34)=F3A(2,4)
	OIC3(35)=F3A(3,4)
C
C
	OIC3(90)=CABA(1,4,4)
	OIC3(91)=CABA(1,4,5)
C
	OIC3(92)=CABA(2,4,4)
	OIC3(93)=CABA(2,4,5)
C                        
	OIC3(94)=F3A(4,4)
	OIC3(95)=F3A(5,4)
C
	REWIND (11)
C
	WRITE (11) OIC3
C
	CLOSE (11)
C
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
621	IF (IFIL .NE. 1) STOP
C
CCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCC
C
C
C
C	code to send data across to bmg and to turn on attfc in bmg
C
C
CCCCCCC
C	READ (62,2009)AL(ISH),(SCR(M,ISH,LIN),M=1,4),
C	1	SCR(5,ISH,LIN)+SCR(6,ISH,LIN),SCR(7,ISH,LIN),
C	1	(SCR(M,ISH,LIN),M=8,11),
C	1	SCR(12,ISH,LIN)+SCR(13,ISH,LIN),SCR(14,ISH,LIN),
C	1	RR,SS,QQ,
C	1	CM,CM2,CM3,SILA(ISH,LIN)
C
C
C	READ (62,3002)AL(ISH),(F2A(M,ISH),M=1,3),(F3A(M,ISH),M=1,3)
C	READ (62,3022)AL(ISH),(F2A(M,ISH),M=1,3),BL2,(F3A(M,ISH),M=1,3),BL3
C
C2009	FORMAT (' ',A1,12F5.1,1X,3F6.1,3X,F4.0,2X,F4.1,2X,F4.0,7X,F6.2)
C3002	FORMAT (' ',A1,3X,2(3F7.2,6X,18X))
C3022	FORMAT (' ',A1,3X,2(3F7.2,F6.0,18X))
CCCCCCC
C
C		loop to convert data to ascii and store it in adp(352)
C
C
C
	CALL SYS$NUMTIM (TDATA,DAT)
C
	LD=TDATA(3)
	LM=TDATA(2)
	LY=TDATA(1)
C
	LY=MOD(LY,100)
C
	WRITE (DATT(1:2),'(I2)')LD
	WRITE (DATT(3:4),'(I2)')LM          
	WRITE (DATT(5:6),'(I2)')LY
C
	IF (DATT(1:1) .EQ. ' ')DATT(1:1)='0'
	IF (DATT(3:3) .EQ. ' ')DATT(3:3)='0'
C
	CODE(1)='0'
	CODE(2)='0'
	CODE(3)='0'
C
C
C
	IF (RECNO .EQ. 2) THEN
C
		CODE(1)='3'
		CODE(2)='3'
		CODE(3)='3'
C           
cccccccccccccccccc
c
c	ELSE IF ((IS .EQ. 1) .AND. (IH .EQ. 1)) THEN
C
C
c		STOP 'SCREEN DATA NOT INPUT YET'
c
cccccccccccccccccc
C
	ELSE
C
		IF (IS .EQ. 1) THEN
C
			CODE(1)='1'
C
			GO TO 3399
C
		END IF 
C
		IF ((IS .EQ. 2) .AND. (IH .EQ. 1)) THEN
C
			CODE(1)='3'
			GO TO 3399
		END IF
C
		IF ((IS .EQ. 2) .AND. (IH .EQ. 2)) THEN
C
			CODE(1)='3'
			CODE(2)='1'
C
			GO TO 3399
C
		END IF 	
C
		IF ((IS .EQ. 3) .AND. (IH .EQ. 1)) THEN
C
			CODE(1)='3'
			CODE(2)='3'
C
			GO TO 3399
C
		END IF 	
C
		IF ((IS .EQ. 3) .AND. (IH .EQ. 2)) THEN
C
			CODE(1)='3'
			CODE(2)='3'
			CODE(3)='1'
C
			GO TO 3399
C
		END IF 	
C
C
	END IF
C
C
C
3399	WRITE (62,23)DATT,(CODE(I5),I5=1,3)
C                                  
C
C
	CLOSE (62)
C
23	FORMAT (A6,3A1,105X)
C
CCCCCCCCCCCCCCCCCCCCCC
C
	WRITE (6,2119)
2119	FORMAT ('0WAITING 10 SECONDS BETWEEN LINK CALLS,PLEASE WAIT')
C
	CALL LIB$WAIT (10.)
C
CCCCCCCCCCCCCCCCCCCCCC
C
	WRITE (6,7512)(CODE(J),J=1,3)
7512	FORMAT ('0SENDING ATTFC DATA TO STEP 3 CONC,PLEASE WAIT'/' ',3A6)
C
C	send data to /2410000,B3 BMG     1200 WORDS
C
	MGM=0
C
3581	FC=1
	BD=3
	BA='2415000'O
	CPR=114
	NR=25
	STAT=0
	FILE='ATTDAT'   ! link dir file name 6 char
	BPROC='ATCNVT'  !put attfc in here after!!!!!!!!!!!!!!!!!!!!!!
	VPROC='      '
C                                                
	CALL VAXLRW(FC,BA,BD,CPR,NR,FILE,BPROC,VPROC,STAT)
C                                  
	IF (STAT .EQ. 1) THEN
C
	CALL LIB$WAIT (5.)
C
	WRITE (6,188)
188	FORMAT (' WAITING TO SEND DATA TO BMG,LINK BUSY')
C
	MGM=MGM+1
C	IF (MGM .GT. 25) THEN
C		WRITE (6,*) 'LINK FAILED'
C		GO TO 2855
C	END IF
C
C
	GO TO 3581
C
	END IF
C
C
2855	IF (RECNO .EQ. 2) THEN
C
		CLOSE (61)
		CALL LIB$SPAWN ('RUN MET_P:STRUKEL')
C
	END IF
C
	CALL LIB$SPAWN ('SET TERM/WIDTH=80')	
C
	STOP 'YOU CAN SWITCH TO BMG NOW IF YOU WANT'
C
588	CLOSE (6)	
	WRITE (6,*) 'OUTPUT PROBLEM, LOOK FOR BAD NUMBERS'
	CALL LIB$WAIT(5.)
C
	STOP
C
	END
