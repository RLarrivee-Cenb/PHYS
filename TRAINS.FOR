C
	PROGRAM	TRAINS
C
C	CALCULATES PELLET TRAIN NUMBERS FOR THE LAST
C	NINE SHIFTS FOR THE STREND FILE
C
	IMPLICIT NONE
C
	INTEGER*4	DATETIME,WBILL,PLANT,CARS,NUM
	INTEGER*4	OCARS,UCARS,CUT1(6),CUT2(6),CHECKN 
	INTEGER*4	CUT4(6),SPLITC(2),FLAGS
	INTEGER*4	FLUXL(16),FLUXH(16),ACIDL(16),ACIDH(16)
	INTEGER*4	I,J,K,L,M,N,AIN,FIN,TEMPX
	INTEGER*4	MX,DX,YX,SHFTX,TX,MM,DD,YY,SHFT
	INTEGER*4	UFO_OPEN
C
	REAL*8		TONS,IRON,SIL,BA,MOIST,ALUM,CAO,MGO,BAL
	REAL*8		TONSX,PHOS,MN,CUT3(6)
	REAL*8		SPLITX(2),EXTRA(3)
	REAL*8		BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP
	REAL*8		WTONS(9),WSIL(9),ETONS(9),ESIL(9)
C
	REAL*4		VALU(24)
C
	CHARACTER*15	FILEX/'OREM:TRAINS.DAT'/
	CHARACTER*12	DATEX(9),DATX
C
	EXTERNAL	UFO_OPEN
C
	OPEN	(UNIT=1,FILE='LOGS:STREND.DAT',
	1	 STATUS='OLD',
	1	 ACCESS='DIRECT',RECORDTYPE='FIXED',
	1	 FORM='UNFORMATTED',RECL=27,SHARED,USEROPEN=UFO_OPEN)
C
	DO 80 J=1,9	!READ IN LAST NINE SHIFTS FROM STREND AND SAVE DATES
C
	READ	(1,REC=J)DATEX(J),VALU
C
80	CONTINUE
C
	CLOSE	(UNIT=1)
C
	OPEN	(UNIT=2,FILE='OREM:WBILL.DAT',ACCESS='DIRECT',
	1	STATUS='OLD',RECORDTYPE='FIXED',RECL=64,SHARED,
	1	FORM='UNFORMATTED',USEROPEN=UFO_OPEN)
C
	READ	(2,REC=1)FLUXL,FLUXH,ACIDL,ACIDH
C
	CLOSE	(UNIT=2)
C
	OPEN	(UNIT=1,FILE=FILEX,STATUS='OLD',ACCESS='KEYED',SHARED,
	1	 RECORDTYPE='FIXED',FORM='UNFORMATTED',RECL=87)
C
500	CONTINUE
C
	READ(1,ERR=2000)DATETIME,WBILL,PLANT,NUM,CARS,
	1		TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1		BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,
	1		BAL,OCARS,UCARS,
	1		CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,
	1		EXTRA,CHECKN
C
	UNLOCK	(1)
C
	AIN=0
	FIN=0
C
	DO 550	I=1,16
		IF ((WBILL .GE. ACIDL(I)).AND.(WBILL .LE. ACIDH(I)))THEN
			AIN=I	!ESTABLISH WAYBILL INDEX
			GOTO 600
		END IF
C
		IF ((WBILL .GE. FLUXL(I)).AND.(WBILL .LE. FLUXH(I)))THEN
			FIN=I	!ESTABLISH WAYBILL INDEX
			GOTO 600
		END IF
C
550	CONTINUE
C
600	CONTINUE
C
	AIN=0	!SKIP MIXED ACID TRAINS TO GENEVA
C
	TEMPX=AIN+FIN
	IF (TEMPX .EQ. 0)GOTO 500	!IF NO INDEX SKIP THIS TRAIN
C
	DO 800	I=1,9	!CHECK THIS TRAIN AGAINST OUR NINE SHIFTS
C
		MX=JIBITS(DATETIME,17,4)!EXTRACT MONTH
		DX=JIBITS(DATETIME,12,5)!EXTRACT DAY
		YX=JIBITS(DATETIME,21,8)!EXTRACT YEAR
		TX=JIBITS(DATETIME,0,12)!EXTRACT LOADING TIME
		YX=YX+1900		!ADD YEAR BIAS BACK TO YEAR
		IF (TX .LT. 630)THEN
			SHFTX=1		!MIDNIGHT SHIFT TRAIN
			GOTO 700
		END IF
C
		IF (TX .LT. 1430)THEN
			SHFTX=2		!DAY SHIFT TRAIN
			GOTO 700
		END IF
C
		IF (TX .LT. 2230)THEN
			SHFTX=3		!AFTERNOON SHIFT
			GOTO 700
		END IF
C
		SHFTX=3
C
700		CONTINUE
C
		IF (DATEX(I)(4:6) .EQ. 'JAN')MM=1
		IF (DATEX(I)(4:6) .EQ. 'FEB')MM=2
		IF (DATEX(I)(4:6) .EQ. 'MAR')MM=3
		IF (DATEX(I)(4:6) .EQ. 'APR')MM=4
		IF (DATEX(I)(4:6) .EQ. 'MAY')MM=5
		IF (DATEX(I)(4:6) .EQ. 'JUN')MM=6
		IF (DATEX(I)(4:6) .EQ. 'JUL')MM=7
		IF (DATEX(I)(4:6) .EQ. 'AUG')MM=8
		IF (DATEX(I)(4:6) .EQ. 'SEP')MM=9
		IF (DATEX(I)(4:6) .EQ. 'OCT')MM=10
		IF (DATEX(I)(4:6) .EQ. 'NOV')MM=11
		IF (DATEX(I)(4:6) .EQ. 'DEC')MM=12
		CALL	OTS$CVT_TI_L(DATEX(I)(1:2),DD,,%VAL(1))
		CALL	OTS$CVT_TI_L(DATEX(I)(8:11),YY,,%VAL(1))
		CALL	OTS$CVT_TI_L(DATEX(I)(12:12),SHFT,,%VAL(1))
C
		IF (MM .NE. MX)GOTO 800
		IF (DD .NE. DX)GOTO 800
		IF (YY .NE. YX)GOTO 800
		IF (SHFT .NE. SHFTX)GOTO 800
C
		IF (TEMPX .LE. 8)THEN	!EAST TRAIN STEP III
			ETONS(I)=ETONS(I)+TONS
			ESIL(I)=ESIL(I)+TONS*SIL
			GOTO 500	!READ ANOTHER TRAIN
C

		ELSE			!WEST TRAIN STEP I/II
			WTONS(I)=WTONS(I)+TONS
			WSIL(I)=WSIL(I)+TONS*SIL
			GOTO 500	!READ ANOTHER TRAIN
		END IF
C
800	CONTINUE
C
	GOTO 500	!NOT ONE OF OUR SHIFTS GO READ ANOTHER RECORD
C
2000	CONTINUE
C
	CLOSE	(UNIT=1)
C
	DO 2200	I=1,9
C
		IF (ETONS(I) .EQ. 0)THEN
			ESIL(I)=0
		ELSE
			ESIL(I)=ESIL(I)/ETONS(I)
		END IF
C
		IF (WTONS(I) .EQ. 0)THEN
			WSIL(I)=0
		ELSE	
			WSIL(I)=WSIL(I)/WTONS(I)
		END IF
C
2200	CONTINUE
C
	OPEN	(UNIT=1,FILE='LOGS:STREND.DAT',
	1	 STATUS='OLD',
	1	 ACCESS='DIRECT',RECORDTYPE='FIXED',
	1	 FORM='UNFORMATTED',RECL=27,SHARED,USEROPEN=UFO_OPEN)
C
	DO 3000	I=1,9
C
		DO 2800	J=1,20
C
			READ	(1,REC=J)DATX,VALU
C
			IF (DATX .EQ. DATEX(I))THEN
				VALU(16)=WSIL(I)
				VALU(17)=ESIL(I)
				WRITE	(1,REC=J)DATX,VALU
				GOTO 3000
			END IF
C
2800		CONTINUE
C
3000	CONTINUE
C
	CLOSE	(UNIT=1)
C
	CALL	EXIT
C
	END
