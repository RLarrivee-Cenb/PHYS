C
	PROGRAM		PTRAIN
C
C	THIS PROGRAM MANAGES THE PELLET TRAIN FILE FOR THE
C	ORE MOVEMENT DEPARTMENT
C
	IMPLICIT NONE
C
	INTEGER*4	DATETIME,LEN,WBILL,PLANT,CARS,NUM
	INTEGER*4	OCARS,UCARS,CUT1(6),CUT2(6) 
	INTEGER*4	CUT4(6),CARSX,SPLITC(2),UFO_OPEN
	INTEGER*4	NUMX,PLANTX,DESTX,TEMP,CHECKN,CHECKNX
	INTEGER*4	FLUXL(16),FLUXH(16),ACIDL(16),ACIDH(16)
C
	REAL*8		TONS,IRON,BT14,SIL,BA,MOIST,ALUM,CAO,MGO,BAL
	REAL*8		TONSX,IRONX,BT14X,SILX,BAX,MOISTX,CUT3(6)
	REAL*8		SPLITX(2),BT14STEP2,BT14STEP3,EXTRA(3)
	REAL*8		ALUMX,CAOX,MGOX
	REAL*8		PHOS,MN,BT12,BT4M,AT14,AT28M,COMP,LCOMP
	REAL*8		PHOSX,MNX,BT12X,BT4MX,AT14X,AT28MX,COMPX,LCOMPX
	REAL*8		PHY2(7),PHY3(7),FEX,LFEX,HFEX,HFE,LFE
	REAL*8		HSIX,LSIX,HALX,LALX,HCAX,LCAX,HMGX,LMGX,HH2X,LH2X,
	1		HMNX,LMNX,HBAX,LBAX,LBT14X,LAT14X,LLCOMPX
C
	INTEGER*4	I,J,K,L,N,M,WBILLX,FLAGS
	INTEGER*4	CHR(13),MX,DX,YX,TX
	INTEGER*4	EAST/890320/,WEST/894320/
	INTEGER*4	STIME(2),STIMEX(2),DIFF,EFLAG
	INTEGER*4	MMX,DDX,YYX
C
	CHARACTER*23	PREDICT,ASCIIDATE
	CHARACTER*1	DAYSX/'1'/,TR
	CHARACTER*1	EST/' '/,SHFT
	CHARACTER*4	PRINTON/' [5i'/
	CHARACTER*4	PRINTOF/' [4i'/
	CHARACTER*1	OPT,FF,MODE,RET,OPTX
	CHARACTER*4	CLEAR/' [2J'/,GRADE
	CHARACTER*3	HOME/' [H'/
	CHARACTER*100	KEYBD,BLANK
	CHARACTER*12	WORDS(13),TDATE,BTDATE
	CHARACTER*17	FILEX/'OREM:TRAINS.DAT99'/
	CHARACTER*3	MTH(12)/'JAN','FEB','MAR','APR',
	1		    'MAY','JUN','JUL','AUG',
	1		    'SEP','OCT','NOV','DEC'/
	CHARACTER*6	CHEM
C
	EXTERNAL	UFO_OPEN
C
	FF=CHAR(12)
	CLEAR(1:1)=CHAR(27)
	HOME(1:1)=CHAR(27)
	PRINTON(1:1)=CHAR(27)
	PRINTOF(1:1)=CHAR(27)
C
	DO 10 I=1,100
		BLANK(I:I)=' '	!SET UP BLANKS FOR INPUT BUFFER
10	CONTINUE
C
	OPEN	(UNIT=6,FILE='SYS$COMMAND',STATUS='UNKNOWN')
C
	OPEN	(UNIT=1,FILE='OREM:WBILL.DAT99',ACCESS='DIRECT',
	1	STATUS='OLD',RECORDTYPE='FIXED',RECL=64,SHARED,
	1	FORM='UNFORMATTED',USEROPEN=UFO_OPEN)
C
	READ	(1,REC=1)FLUXL,FLUXH,ACIDL,ACIDH	!GET TRAIN WBILLS
C
	CLOSE	(UNIT=1)
C
	OPEN	(UNIT=1,FILE=FILEX,STATUS='OLD',ACCESS='KEYED',SHARED,
	1	 RECORDTYPE='FIXED',FORM='UNFORMATTED',RECL=87)
C
100	CONTINUE
C
	CALL	CLRSCREEN
C
110	CONTINUE
C
	WRITE	(6,125)
125	FORMAT	(' PLEASE SELECT YOUR OPTION... I - INPUT A TRAIN',/
	1	 '                              R - REMOVE A TRAIN',/
	1	 '                              D - DISPLAY A TRAIN',/
	1	 '                              C - REBUILD CUTS',/
	1	 '                              M - MODIFY TRAIN ITEM',/
	1	 '                              S - SPLIT TRAIN',/
	1	 ' OR TYPE <RETURN> TO QUIT')
C
	READ	(6,150)LEN,OPT
150	FORMAT	(Q,A)
C
	IF (LEN .EQ. 0)GOTO 99999	!GO HERE TO SHUT OFF
C
	IF (OPT .EQ. 'R')GOTO 1000 	!REMOVE OPTION GO HERE
	IF (OPT .EQ. 'D')GOTO 1000      !DISPLAY OPTION GO HERE
	IF (OPT .EQ. 'C')GOTO 1000	!REBUILD CUTS OPTION GO HERE
	IF (OPT .EQ. 'I')GOTO 2000      !INPUT OPTION GO HERE
	IF (OPT .EQ. 'M')GOTO 1000	!MODIFY TRAIN
	IF (OPT .EQ. 'S')GOTO 1000	!SPLIT TRAIN
C
	WRITE	(6,175)
175	FORMAT	(/' INVALID OPTION PLEASE TRY AGAIN')
	GOTO 110
C
1000	CONTINUE
C
	CALL	CLRSCREEN
C
1010	CONTINUE
C
	WRITE	(6,1100)
1100	FORMAT	(' PLEASE TYPE DESIRED WAYBILL...'/,
	1	 ' OR <RET> FOR PREVIOUS PROMPT')
 
	KEYBD=BLANK
C
	READ	(6,1125)LEN,KEYBD 	!GET WAYBILL NO.
1125	FORMAT	(Q,A)
C
	IF (LEN .EQ. 0)GOTO 100	!GO BACK TO PREVIOUS PROMPT
C
	CALL	READKEYBD(KEYBD,WORDS,CHR)
C
	CALL	OTS$CVT_TI_L(WORDS(1),WBILLX,,%VAL(1))
C
	READ(1,ERR=1200,KEYEQ=WBILLX,KEYID=1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
        GOTO 1300	!FOUND TRAIN GO AND CONTINUE
C
1200	CONTINUE
C
	WRITE	(6,1225)
1225	FORMAT	(/' UNABLE TO LOCATE TRAIN ... PLEASE CHECK WAYBILL',/
	1	  ' AND TRY AGAIN')
C
	GOTO 1010	!GO ASK FOR WAYBILL AGAIN
C
1300	CONTINUE
C
	IF (OPT .EQ. 'R')THEN	!IF THIS IS REMOVE OPTION
		DELETE 	(1)	!REMOVE OR DELETE TRAIN RECORD
		WRITE	(6,1325)
1325		FORMAT(/' WAYBILL SUCCESSFULLY REMOVED...'/)
		GOTO 1010	!ASK FOR A NEW WAYBILL
	END IF
C
1330	CONTINUE
C
	IF ((OPT .EQ. 'D').OR.(OPT .EQ. 'M'))THEN	!IF THIS IS DISPLAY
C                                                       !OR MODIFY
		IF (OPT .EQ. 'M')GOTO 1380
C
1350		CONTINUE
C
		WRITE	(6,1360)
1360		FORMAT	(/' SELECT PRINT MODE ... S = SCREEN   P = PRINTER'/)
		READ	(6,1370)MODE
1370		FORMAT	(A)
		IF (MODE .EQ. 'P')GOTO 1380
		IF (MODE .EQ. 'S')GOTO 1380
		GOTO 1350
C
1380		CONTINUE
		CALL	LIB$SPAWN('SET TERM/WIDTH=132')
C
		IF (OPT .EQ. 'M')GOTO 1390
		IF (MODE .EQ. 'S')GOTO 1390
C
		CALL	LIB$SPAWN('SET TERM/FORM')
C
		WRITE	(6,1385)PRINTON		!LIST GOES TO PRINTER
1385		FORMAT	(' ',A)
C
1390		CONTINUE

   		WRITE	(6,1400)
1400		FORMAT	(/' ',3X,'B/L',2X,'TRAIN',2X,'TIME',5X,'DATE',
	1		 6X,'PLANT',1X,'CARS',7X,'TONS',1X,'LOADER',
	1		 5X,'FE',3X,'SIO2',
	1		 4X,'B/A',4X,'H2O',2X,'AL203',4X,'CAO',4X,'MGO',
	1		 5X,'MN',6X,'P')
C
		YX=JIBITS(DATETIME,21,8)!EXTRACT YEAR
		MX=JIBITS(DATETIME,17,4)!EXTRACT MONTH
		DX=JIBITS(DATETIME,12,5)!EXTRACT DAY
		TX=JIBITS(DATETIME,0,12)!EXTRACT LOADING TIME
		YX=YX+1900		!ADD YEAR BIAS BACK TO YEAR
C
		EST=' '
		IF (BJTEST(FLAGS,0))EST='E'	!ESTIMATED WEIGHT
C
		WRITE	(6,1425)WBILL,NUM,TX,MX,DX,YX,PLANT,CARS,EST,TONS,
	1		CHECKN,IRON,SIL,BA,MOIST,ALUM,CAO,MGO,MN,PHOS
1425		FORMAT	(' ',I6,I7,I6,I4,'-',I2,'-',I4,I8,I5,1X,A,F9.2,I7,
	1		 8F7.2,F7.3/)		
C
		GRADE='    '
		FEX=0
C
	DO 1416 N=1,16	!LOCATE INDEX TO WAYBILL
	       IF ((WBILLX .GE. ACIDL(N)).AND.(WBILLX .LE. ACIDH(N)))THEN
			GRADE='ACID'
			GOTO 1419
		END IF
C
1416	CONTINUE
C
	DO 1417 N=1,16	!LOCATE INDEX TO WAYBILL
	       IF ((WBILLX .GE. FLUXL(N)).AND.(WBILLX .LE. FLUXH(N)))THEN
			GRADE='FLUX'
			GOTO 1419
		END IF
C
1417	CONTINUE
C
1419		CONTINUE
C
		IF (GRADE .EQ. 'FLUX')THEN
			FEX=((IRON-0.87)*1.4297)+1.11882+SIL+CAO+MGO
	1				+ALUM+MN+0.073
		END IF
C
		IF (GRADE .EQ. 'ACID')THEN
			FEX=((IRON-0.40)*1.4297)+0.5694+SIL+CAO+MGO+ALUM+MN
		END IF
C
		WRITE	(6,1415)
1415		FORMAT	(' ',66X,'BT',5X,'BT',5X,'BT',5X,'AT',5X,'AT',5X,
	1		'AVG',3X,'COMP%',/,' ',65X,'+1/2',3X,
	1		'+1/4',4X,'+4M',3X,'+1/4',3X,'-28M',3X,'COMP',
	1		3X,'<200    OXIDES')
C
		WRITE	(6,1420)BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,FEX
1420		FORMAT	(' ',62X,5F7.1,F7.0,F7.1,F10.3/)
C
		IF (SPLITC(1) .NE. 0)THEN
C
			WRITE	(6,1427)SPLITC(1),SPLITX(1),SPLITC(2),SPLITX(2)
1427			FORMAT	(' ',29X,'EAST SPLIT',I5,F11.2,/
	1			 ' ',29X,'WEST SPLIT',I5,F11.2/)
C
		END IF
C
		CARSX=CARS	!INITIALIZE CAR BALANCE
		BAL=TONS	!INITIALIZE TONS BALANCE
C
		DO 1500 I=1,6	!PRINT CUTS THIS TRAIN
C
			IF (CUT1(I) .EQ. 0)GOTO 1500
C
			YX=JIBITS(CUT1(I),21,8)!EXTRACT YEAR
			MX=JIBITS(CUT1(I),17,4)!EXTRACT MONTH
			DX=JIBITS(CUT1(I),12,5)!EXTRACT DAY
			TX=JIBITS(CUT1(I),0,12)!EXTRACT LOADING TIME
			YX=YX+1900		!ADD YEAR BIAS BACK TO YEAR
C
			TR=' '
			IF (BJTEST(FLAGS,I))TR='T'
C
			WRITE	(6,1450)I,CUT2(I),CUT3(I),CUT4(I),MX,DX,
	1				YX,TX,TR
1450			FORMAT	(' ',32X,'CUT #',I1,2X,I4,F11.2,I8,I5,'-',
	1			 I2,'-',I4,I6,2X,A)
C
			CARSX=CARSX-CUT2(I)	!SUBTRACT OUT CARS
			BAL=BAL-CUT3(I)		!SUBTRACT OUT TONS
C
1500		CONTINUE
C
		WRITE	(6,1525)CARSX,BAL
1525		FORMAT	(/' ',32X,'BALANCE',I5,F11.2)
C
		IF (OPT .EQ. 'M')GOTO 1790
C
		IF (MODE .EQ. 'S')THEN
			WRITE	(6,1550)
1550			FORMAT	(/' PRESS <RET> KEY TO CONTINUE')
			READ	(6,1575)RET
1575			FORMAT	(A)
			GOTO 1600
		END IF
C
		WRITE	(6,1385)PRINTOF		!RETURN TO SCREEN
C
1600		CONTINUE
C
		CALL	LIB$SPAWN('SET TERM/WIDTH=80')
C
    		GOTO 1000	!GO ASK FOR ANOTHER WAYBILL
C
	END IF
C
1675	CONTINUE
C
	IF (OPT .EQ. 'C')THEN
C
		WRITE	(6,1700)
1700		FORMAT	(' TYPE CUT#,TIME,DATE,CARS,TONS,DESTINATION'/
	1		 ' OR <RET> FOR PREVIOUS PROMPT'/)
C
	KEYBD=BLANK
	READ	(6,1125)LEN,KEYBD 	!ACCESS DATA
C
	IF (LEN .EQ. 0)GOTO 1000	!GO BACK TO PREVIOUS PROMPT
C
	CALL	READKEYBD(KEYBD,WORDS,CHR)
C
	CALL	OTS$CVT_TI_L(WORDS(1),J,,%VAL(1))	!INDEX TO CUT
	CALL	OTS$CVT_TI_L(WORDS(2),TX,,%VAL(1))    	!CUT TIME
	CALL	OTS$CVT_TI_L(WORDS(3),MX,,%VAL(1))	!MONTH
	CALL	OTS$CVT_TI_L(WORDS(4),DX,,%VAL(1))      !DAY
	CALL	OTS$CVT_TI_L(WORDS(5),YX,,%VAL(1))      !YEAR
	CALL	OTS$CVT_TI_L(WORDS(6),CARSX,,%VAL(1))   !CARS
	READ	(WORDS(7),'(BN,F12.0)')TONSX               !TONS
	CALL	OTS$CVT_TI_L(WORDS(8),DESTX,,%VAL(1))   !DESTINATION
C
	IF (TX .EQ. 0)GOTO 1730	!THEY ARE REMOVING CUT
C
	IF (YX .LT. 1989)THEN
		WRITE	(6,1725)
1725		FORMAT	(' YEAR MUST BE FOUR DIGITS...TRY AGAIN'/)
		GOTO 1675
	END IF
C
	YX=YX-1900
C
1730	CONTINUE
C
		IF ((J .LT.1).OR.(J .GT. 6))THEN
C
			WRITE	(6,1750)
1750			FORMAT	(' CUT NUMBER INCORRECT...TRY AGAIN'/)
C
		GOTO 1675
C
		END IF
C
		CUT2(J)=CARSX
		CUT3(J)=TONSX
		CUT4(J)=DESTX
		YX=JISHFT(YX,21)	!PACK DATE AND LOADING TIME 
		MX=JISHFT(MX,17)
        	DX=JISHFT(DX,12)
		CUT1(J)=0
		CUT1(J)=JIOR(CUT1(J),YX)
		CUT1(J)=JIOR(CUT1(J),MX)
		CUT1(J)=JIOR(CUT1(J),DX)
		CUT1(J)=JIOR(CUT1(J),TX)
		IF (WORDS(9) .EQ. 'T')THEN
			FLAGS=JIBSET(FLAGS,(J))
		ELSE
			FLAGS=JIBCLR(FLAGS,(J))
		END IF
C
	REWRITE	(1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
	READ(1,KEYEQ=WBILLX,KEYID=1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BA,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
	UNLOCK	(1)
C
		GOTO 1675	!GO ASK FOR NEXT CUT
C
	END IF
C

1790	CONTINUE
C
	IF (OPT .EQ. 'M')THEN	!MODIFY OPTION
C
1800		CONTINUE
C
		WRITE	(6,1825)
1825		FORMAT	(' THE TRAIN ITEM CODES ARE AS FOLLOWS:'/,
	1	'  TN    - TRAIN #      CARS - CARS     H2O - MOIST       P',
	1	'     - PHOS         BT12 - BT +1/2   AT28M - AT -28M'/,
	1	'  PC    - PLANT CODE   TONS - TONS     AL  - ALUM        MN',
	1	'    - MANG         BT14 - BT +1/4   COMP  - COMPRESSIONS'/,
	1	'  UCARS - UNDER CARS   FE   - IRON     CAO - CALCIUM     ',
	1	'EST   - EST. WGT     BT4M - BT +4M    LCOMP - %COMP<200#'/,
	1	'  OCARS - OVER  CARS   SIO2 - SILICA   MGO - MAGNESIUM   ',
	1	'CHECK - LDR CHECK#   AT14 - AT +1/4'/)
C
		WRITE	(6,1835)
1835		FORMAT	(' TYPE TRAIN ITEM CODE,NEW VALUE'/,
	1		 ' OR <RET> FOR PREVIOUS PROMPT')
C
		KEYBD=BLANK
		READ	(6,1125)LEN,KEYBD 	!ACCESS DATA
C
		IF (LEN .EQ. 0)THEN	!GO BACK TO PREVIOUS PROMPT
			CALL	LIB$SPAWN('SET TERM/WIDTH=80')
			GOTO 1000
		END IF
C
		CALL	READKEYBD(KEYBD,WORDS,CHR)
C
		IF (WORDS(1)(1:2) .EQ. 'TN')THEN	!CHANGE TRAIN NUMBER
			CALL	OTS$CVT_TI_L(WORDS(2),NUM,,%VAL(1))
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:2) .EQ. 'PC')THEN	!CHANGE PLANT CODE
			CALL	OTS$CVT_TI_L(WORDS(2),PLANT,,%VAL(1))
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:4) .EQ. 'TONS')THEN	!CHANGE TONS
			READ	(WORDS(2),'(BN,F12.0)')TONS
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:4) .EQ. 'CARS')THEN	!CHANGE CARS
			CALL	OTS$CVT_TI_L(WORDS(2),CARS,,%VAL(1))
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:5) .EQ. 'UCARS')THEN	!CHANGE UCARS
			CALL	OTS$CVT_TI_L(WORDS(2),UCARS,,%VAL(1))
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:5) .EQ. 'OCARS')THEN	!CHANGE OCARS
			CALL	OTS$CVT_TI_L(WORDS(2),OCARS,,%VAL(1))
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:5) .EQ. 'CHECK')THEN	!CHANGE LDR CHECK#
			CALL	OTS$CVT_TI_L(WORDS(2),CHECKN,,%VAL(1))
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:2) .EQ. 'FE')THEN	!CHANGE IRON
			READ	(WORDS(2),'(BN,F12.0)')IRON
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:1) .EQ. 'P')THEN	!CHANGE PHOS
			READ	(WORDS(2),'(BN,F12.0)')PHOS
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:2) .EQ. 'MN')THEN	!CHANGE MANGANESE
			READ	(WORDS(2),'(BN,F12.0)')MN
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:4) .EQ. 'BT14')THEN	!CHANGE BEFORE TUMBLE
			READ	(WORDS(2),'(BN,F12.0)')BT14
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:4) .EQ. 'SIO2')THEN	!CHANGE SILICA
			READ	(WORDS(2),'(BN,F12.0)')SIL
			BA=(CAO+MGO)/(SIL+ALUM)
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:2) .EQ. 'AL')THEN	!CHANGE ALUMINUM
			READ	(WORDS(2),'(BN,F12.0)')ALUM
			BA=(CAO+MGO)/(SIL+ALUM)         !RECALC BA RATIO
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:3) .EQ. 'CAO')THEN	!CHANGE CALCIUM
			READ	(WORDS(2),'(BN,F12.0)')CAO
			BA=(CAO+MGO)/(SIL+ALUM)         !RECALC BA RATIO
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:3) .EQ. 'MGO')THEN	!CHANGE MANGANESE
			READ	(WORDS(2),'(BN,F12.0)')MGO
			BA=(CAO+MGO)/(SIL+ALUM)         !RECALC BA RATIO
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:3) .EQ. 'H2O')THEN	!CHANGE MOISTURE
			READ	(WORDS(2),'(BN,F12.0)')MOIST
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:4) .EQ. 'BT12')THEN	!CHANGE BT +1/2
			READ	(WORDS(2),'(BN,F12.0)')BT12
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:4) .EQ. 'BT4M')THEN	!CHANGE BT +4M
			READ	(WORDS(2),'(BN,F12.0)')BT4M
			GOTO 1900
		END IF
C
C
		IF (WORDS(1)(1:4) .EQ. 'AT14')THEN	!CHANGE AT +1/4
			READ	(WORDS(2),'(BN,F12.0)')AT14
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:5) .EQ. 'AT28M')THEN	!CHANGE AT -28M
			READ	(WORDS(2),'(BN,F12.0)')AT28M
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:4) .EQ. 'COMP')THEN	!CHANGE COMPRESSIONS
			READ	(WORDS(2),'(BN,F12.0)')COMP
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:5) .EQ. 'LCOMP')THEN	!CHANGE COMP<200#
			READ	(WORDS(2),'(BN,F12.0)')LCOMP
			GOTO 1900
		END IF
C
		IF (WORDS(1)(1:3) .EQ. 'EST')THEN	!ESTIMATED WEIGHT
			IF (WORDS(2)(1:1) .EQ. 'E')FLAGS=JIBSET(FLAGS,0)
			IF (WORDS(2)(1:1) .EQ. ' ')FLAGS=JIBCLR(FLAGS,0)
		END IF
C
1900		CONTINUE
C
	REWRITE	(1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
	READ(1,KEYEQ=WBILLX,KEYID=1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
		GOTO 1330	!GO ASK FOR NEXT ITEM
C
	END IF
C
	IF (OPT .EQ. 'S')THEN	!SPLIT THE TRAIN
C
		CALL	CLRSCREEN
C
		WRITE	(6,1925)
1925		FORMAT	(' TYPE EAST CARS,EAST TONS,WEST CARS,WEST TONS',/
	1		 ' OR <RET> FOR PREVIOUS PROMPT'/)
C
		KEYBD=BLANK
		READ	(6,1125)LEN,KEYBD 	!ACCESS DATA
C
		IF (LEN .EQ. 0)GOTO 1000	!GO BACK TO PREVIOUS PROMPT
C
		CALL	READKEYBD(KEYBD,WORDS,CHR)
C
		CALL	OTS$CVT_TI_L(WORDS(1),SPLITC(1),,%VAL(1))
		CALL	OTS$CVT_TI_L(WORDS(3),SPLITC(2),,%VAL(1))
		READ	(WORDS(2),'(BN,F12.0)')SPLITX(1)
		READ	(WORDS(4),'(BN,F12.0)')SPLITX(2)
C
		REWRITE	(1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
		READ(1,KEYEQ=WBILLX,KEYID=1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
	UNLOCK	(1)
C
		GOTO 1000	!GO ASK FOR NEXT WAYBILL
C
	END IF
C
2000 	CONTINUE
C
	CALL	CLRSCREEN
C
2020	CONTINUE
C
	WRITE	(6,2025)
2025	FORMAT	(' TYPE WAYBILL,TRAIN NO.,TIME,DATE(MM-DD-YYYY),CHECK#',
	1	/' OR PUSH <RET> FOR PREVIOUS PROMPT')
C
	KEYBD=BLANK
	READ	(6,1125)LEN,KEYBD 	!ACCESS DATA
C
	IF (LEN .EQ. 0)GOTO 100	!GO BACK TO PREVIOUS PROMPT
C
	CALL	READKEYBD(KEYBD,WORDS,CHR)
C
	CALL	OTS$CVT_TI_L(WORDS(1),WBILLX,,%VAL(1))	!WAYBILL
	CALL	OTS$CVT_TI_L(WORDS(2),NUMX,,%VAL(1))    !TRAIN #
	CALL	OTS$CVT_TI_L(WORDS(3),TX,,%VAL(1))      !LOADING TIME
	CALL	OTS$CVT_TI_L(WORDS(4),MX,,%VAL(1))      !MONTH
	CALL	OTS$CVT_TI_L(WORDS(5),DX,,%VAL(1))      !DAY
	CALL	OTS$CVT_TI_L(WORDS(6),YX,,%VAL(1))      !YEAR
	CALL	OTS$CVT_TI_L(WORDS(7),CHECKNX,,%VAL(1)) !LOADER CHECK#
	MMX=MX
	DDX=DX
	YYX=YX
C
	IF (YX .LT. 1989)THEN
		WRITE	(6,2030)
2030		FORMAT	(' YEAR MUST BE FOUR DIGITS...TRY AGAIN'/)
		GOTO 2020
	END IF
C
	YX=YX-1900
C
	GRADE='    '
C
	DO 2035 N=1,16	!LOCATE INDEX TO WAYBILL
	       IF ((WBILLX .GE. ACIDL(N)).AND.(WBILLX .LE. ACIDH(N)))THEN
			IF (N .LE. 8)THEN
				PLANTX=EAST	!PLANT CODE FOR EAST POCKET
			ELSE
				PLANTX=WEST	!PLANT CODE FOR WEST POCKET
			END IF
C
			GRADE='ACID'
			GOTO 2053
		END IF
C
2035	CONTINUE
C
	DO 2040 N=1,16	!LOCATE INDEX TO WAYBILL
	       IF ((WBILLX .GE. FLUXL(N)).AND.(WBILLX .LE. FLUXH(N)))THEN
			IF (N .LE. 8)THEN
				PLANTX=EAST	!PLANT CODE FOR EAST POCKET
			ELSE
				PLANTX=WEST	!PLANT CODE FOR WEST POCKET
			END IF
C
			GRADE='FLUX'
			GOTO 2053
		END IF
C
2040	CONTINUE
C
	PLANTX=0	!IF CANNOT FIND WAYBILL MAKE PLANT CODE ZERO
C
2053	CONTINUE
C
	IF (GRADE .EQ. '    ')GOTO 2020	!CANNOT FIND WAYBILL
C
	WRITE	(6,2050)
2050	FORMAT	(/' TYPE CARS,TONS,FE,SIO2,H2O,AL,CAO,MGO,MN',
	1	  ',E(IF EST TONS)',/
	1	  ' OR <RET> FOR PREVIOUS PROMPT')
C
	KEYBD=BLANK
	READ	(6,1125)LEN,KEYBD 	!ACCESS DATA
C
	IF (LEN .EQ. 0)GOTO 2020	!GO BACK TO PREVIOUS PROMPT
C
	CALL	READKEYBD(KEYBD,WORDS,CHR)
C
C
	CALL	OTS$CVT_TI_L(WORDS(1),CARSX,,%VAL(1))	!CARS
	READ	(WORDS(2),'(BN,F12.0)')TONSX
	READ	(WORDS(3),'(BN,F12.0)')IRONX
	READ	(WORDS(4),'(BN,F12.0)')SILX
	READ	(WORDS(5),'(BN,F12.0)')MOISTX
	READ	(WORDS(6),'(BN,F12.0)')ALUMX
	READ	(WORDS(7),'(BN,F12.0)')CAOX
	READ	(WORDS(8),'(BN,F12.0)')MGOX
	READ	(WORDS(9),'(BN,F12.0)')MNX
	PHOSX=0.012
	BAX=(CAOX+MGOX)/(SILX+ALUMX)
	EFLAG=0
C
C	HERE WE WILL DO ERROR CHECKING ON TRAIN CHEMISTRY
C
	IF (GRADE .EQ. '    ')GOTO 2099	!IF NO GRADE SKIP CHECK
C
	IF (GRADE .EQ. 'FLUX')THEN	!LOAD UP FLUX LIMITS
C
		HSIX=4.52
		LSIX=3.98
		HALX=0.23
		LALX=0.00	!PER MARLIN FILSON  10-09-1995
		HCAX=3.91
		LCAX=3.13
		HMGX=1.22
		LMGX=0.98
		HH2X=4.60
		LH2X=1.00
		HMNX=0.14
		LMNX=0.08
		LFEX=99.75
		HFEX=100.25
		LBAX=0.92
		HBAX=1.16
		LBT14X=97.0
		LAT14X=95.0
		LLCOMPX=400
		HFE=64.00
		LFE=63.16
C
		FEX=((IRONX-0.87)*1.4297)+1.11882+SILX+CAOX+MGOX
	1				+ALUMX+MNX+0.073
C
	END IF
C
	IF (GRADE .EQ. 'ACID')THEN	!LOAD UP ACID LIMITS
C
		HSIX=5.76
		LSIX=5.04
		HALX=0.29
		LALX=0.13
		HCAX=0.60
		LCAX=0.25
		HMGX=0.50
		LMGX=0.25
		HH2X=6.00
		LH2X=0.10
		HMNX=0.17
		LMNX=0.05
		HFEX=100.25
		LFEX=99.75
		LBT14X=97.5
		LAT14X=95.0
		LLCOMPX=450
C
		FEX=((IRONX-0.40)*1.4297)+0.5694+SILX+CAOX+MGOX+ALUMX+MNX
C
	END IF
C
	WRITE	(6,2052)FEX
2052	FORMAT	(//' ','OXIDES FOR THIS TRAIN = ',F7.3//)
C
	CALL	LIB$WAIT(10.0)
C
	IF (GRADE .EQ. 'FLUX')THEN
C
		IF ((BAX .LT. LBAX).OR.(BAX .GT. HBAX))THEN
			CHEM='% B/A'
			WRITE	(6,2055)CHEM
			EFLAG=1
		WRITE	(6,1385)PRINTON		!LIST GOES TO PRINTER
C
		WRITE	(6,5555)FF,MMX,DDX,YYX,WBILLX,CHEM
5555		FORMAT	(///' ',A,10X,'MINNTAC ORE MOVEMENT'/,
	1		 ' ',10X,'OUT OF SPEC TRAIN REPORT'///,
	1		 ' ',1X,'DATE:',11X,'(',I2,'-',I2,'-',I4,')'//,
	1		 ' ',1X,'WAYBILL:',8X,I4//,
	1		 ' ',1X,'OUT OF SPEC:',4X,A//,
	1		 ' ',10X,'PLEASE TRY TO BLEND THIS MINNTAC'/,
	1		 ' ',10X,'OUT OF SPEC TRAIN IF POSSIBLE AT'/,
	1		 ' ',10X,'THE DOCKS.'//,
	1		 ' ',1X,'COORD:',3X,'PLEASE FAX THIS REPORT TO DOCKS.'/,
	1		 ' ',10X,'FILE CONFIRMATION AND REPORT WITH TRAIN'/,
	1		 ' ',10X,'SHEETS.')
C
		WRITE	(6,1385)PRINTOF		!RETURN TO SCREEN
C
		END IF
C
	END IF
C
	IF ((SILX .LT. LSIX).OR.(SILX .GT. HSIX))THEN
		CHEM='% SIO2'
		WRITE	(6,2055)CHEM
2055		FORMAT	(' ',2X,A,2X,'IS OUT OF LIMITS')
		EFLAG=1
		WRITE	(6,1385)PRINTON		!LIST GOES TO PRINTER
C
		WRITE	(6,5555)FF,MMX,DDX,YYX,WBILLX,CHEM
C
		WRITE	(6,1385)PRINTOF		!RETURN TO SCREEN
C
	END IF
C
C	IF ((ALUMX .LT. LALX).OR.(ALUMX .GT. HALX))THEN
C 		CHEM='%AL2O3'
C		WRITE	(6,2055)CHEM
C		EFLAG=1
C	END IF
C
	IF ((IRONX .LT. LFE).OR.(IRONX .GT. HFE))THEN
		CHEM='%FE   '
		WRITE	(6,2055)CHEM
		EFLAG=1
	END IF
C
	IF ((CAOX .LT. LCAX).OR.(CAOX .GT. HCAX))THEN
		CHEM='% CAO '
		WRITE	(6,2055)CHEM
		EFLAG=1
	END IF
C
	IF ((MGOX .LT. LMGX).OR.(MGOX .GT. HMGX))THEN
		CHEM='% MGO '
		WRITE	(6,2055)CHEM
		EFLAG=1
	END IF
C
C	IF ((MOISTX .LT. LH2X).OR.(MOISTX .GT. HH2X))THEN
	IF (MOISTX .GT. HH2X)THEN
		CHEM='% H2O '
		WRITE	(6,2055)CHEM
		EFLAG=1
	END IF
C
C	IF ((MNX .LT. LMNX).OR.(MNX .GT. HMNX))THEN
C		CHEM='% MN  '
C		WRITE	(6,2055)CHEM
C		EFLAG=1
C	END IF
C
	IF ((FEX .LT. LFEX).OR.(FEX .GT. HFEX))THEN
		CHEM='OXIDES'
		WRITE	(6,2055)CHEM
		EFLAG=1
	END IF
C
	IF (EFLAG .EQ. 1)THEN	!IF WE HAVE FOUND AN ERROR
C
		WRITE	(6,2060)
2060		FORMAT	(' ','DO YOU WISH TO CONTINUE WITH THE INPUT ERROR'/,
	1		 ' ','TYPE (Y)ES OR (N)O.....')
		READ	(6,150)LEN,OPTX
C
		IF (LEN .EQ. 0)GOTO 99999	!IF NO INPUT SHUT OFF
C
		IF (OPTX .EQ. 'Y')GOTO 2099	!CONTINUE WITH ERROR
C
		IF (OPTX .EQ. 'N')GOTO 2053     !ASK FOR NEW INPUT
C
	END IF
C
2099	CONTINUE
C
    	UCARS=0
	OCARS=0
	SPLITC(1)=0
	SPLITC(2)=0
	SPLITX(1)=0
	SPLITX(2)=0
	FLAGS=0
C
C	FIND OUT IF TRAIN ALREADY EXITS
C
	READ	(1,ERR=2100,KEYEQ=WBILLX,KEYID=1)DATETIME,WBILL,PLANT,NUM,CARS,
	1	TONS,IRON,SIL,MOIST,PHOS,MN,ALUM,CAO,MGO,BA,
	1	BT12,BT14,BT4M,AT14,AT28M,COMP,LCOMP,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKN
C
	WRITE	(6,2075)
2075	FORMAT	(' ','WARNING!!!!! THIS WAYBILL ALREADY IN TRAIN FILE'/,
	1	 ' ','IT WILL BE DELETED AND REPLACED WITH CURRENT INPUT'/,
	1	 ' ','TYPE (Y)ES TO CONTINUE ... OR (N)O TO ABORT.....')
		READ	(6,150)LEN,OPTX
C
		IF (LEN .EQ. 0)GOTO 99999	!IF NO INPUT SHUT OFF
C
		IF (OPTX .EQ. 'Y')GOTO 2080	!CONTINUE WITH ERROR
C
		IF (OPTX .EQ. 'N')GOTO 2000     !ASK FOR NEW INPUT
C
2080	CONTINUE
C
	DELETE(1)	!DELETE THE TRAIN RECORD BEFORE INSERTING NEW VERSION
C
        GOTO 2200	!FOUND TRAIN GO AND CONTINUE
C
2100	CONTINUE
C
	DO 2150 I=1,6
		CUT1(I)=0	!SINCE THIS IS NEW TRAIN
		CUT2(I)=0       !CLEAR OUT CUTS
		CUT3(I)=0
		CUT4(I)=0
2150	CONTINUE
C
	BAL=TONSX	
C
2200	CONTINUE
C
	ASCIIDATE(3:3)='-'	!BUILD ASCII DATE IN CASE WE HAVE TO 
	ASCIIDATE(7:7)='-'      !MOVE BACK ONE DAY
	ASCIIDATE(12:23)='            '
	ASCIIDATE(4:6)=MTH(MX)	!INSERT MONTH
	CALL	OTS$CVT_L_TI(DX,ASCIIDATE(1:2),%VAL(2))	!INSERT DAY
	TEMP=YX+1900
	CALL	OTS$CVT_L_TI(TEMP,ASCIIDATE(8:11),%VAL(4))	!INSERT YEAR
	IF (ASCIIDATE(1:1) .EQ. '0')ASCIIDATE(1:1)=' '
C
	YX=JISHFT(YX,21)	!PACK DATE AND LOADING TIME 
	MX=JISHFT(MX,17)
        DX=JISHFT(DX,12)
	DATETIME=0
	DATETIME=JIOR(DATETIME,YX)
	DATETIME=JIOR(DATETIME,MX)
	DATETIME=JIOR(DATETIME,DX)
	DATETIME=JIOR(DATETIME,TX)
C
	IF (WORDS(10)(1:1) .EQ. 'E')FLAGS=JIBSET(FLAGS,0)  !ESTIMATED TONS
C
	IF (TX .LE. 2400)SHFT='1'	!CALCULATE SHIFT THAT
	IF (TX .LT. 2230)SHFT='3'	!TRAIN WAS LOADED OUT
	IF (TX .LT. 1430)SHFT='2'	!ON
	IF (TX .LT. 630)SHFT='1'
C
	IF (SHFT .EQ. '3')THEN	!WE MUST BACK UP ONE SHIFT
		SHFT='2'
		GOTO 2350
	END IF
C
	IF (SHFT .EQ. '2')THEN
		SHFT='1'
		GOTO 2350
	END IF
C
	IF (SHFT .EQ. '1')THEN 		!WE MUST BACK UP ONE SHIFT
		SHFT='3'		!AND ALSO ONE DAY
		IF (TX .GE. 2230)GOTO 44444
		CALL	SYS$BINTIM(ASCIIDATE,STIME)
		CALL	SYS$BINTIM(DAYSX,STIMEX)
		CALL	LIB$SUB_TIMES(STIME,STIMEX,DIFF)
		CALL	SYS$ASCTIM(,ASCIIDATE,DIFF,)
44444		CONTINUE
	END IF
C
2350	CONTINUE
C
	IF (ASCIIDATE(1:1) .EQ. ' ')ASCIIDATE(1:1)='0'
	TDATE(1:11)=ASCIIDATE(1:11)	!DATE AND SHIFT FOR
	TDATE(12:12)=SHFT		!BEFORE TUMBLES
C
	OPEN	(UNIT=3,FILE='OREM:BTUM.DAT',STATUS='OLD',
	1	 ACCESS='DIRECT',RECORDTYPE='FIXED',
	1	 FORM='UNFORMATTED',RECL=31,SHARED,
	1	 USEROPEN=UFO_OPEN)
C
	DO 2400	I=1,100
		READ	(3,REC=I)BTDATE,PHY2,PHY3
		IF (BTDATE .EQ. TDATE)THEN
			IF (PLANTX .EQ. 894320)BT12X=PHY2(1)
			IF (PLANTX .EQ. 894320)BT14X=PHY2(2)
			IF (PLANTX .EQ. 894320)BT4MX=PHY2(3)
			IF (PLANTX .EQ. 894320)AT14X=PHY2(4)
			IF (PLANTX .EQ. 894320)AT28MX=PHY2(5)
			IF (PLANTX .EQ. 894320)COMPX=PHY2(6)
			IF (PLANTX .EQ. 894320)LCOMPX=PHY2(7)
			IF (PLANTX .EQ. 890320)BT12X=PHY3(1)
			IF (PLANTX .EQ. 890320)BT14X=PHY3(2)
			IF (PLANTX .EQ. 890320)BT4MX=PHY3(3)
			IF (PLANTX .EQ. 890320)AT14X=PHY3(4)
			IF (PLANTX .EQ. 890320)AT28MX=PHY3(5)
			IF (PLANTX .EQ. 890320)COMPX=PHY3(6)
			IF (PLANTX .EQ. 890320)LCOMPX=PHY3(7)
			CLOSE	(UNIT=3)
			GOTO 2500
		END IF
2400	CONTINUE
C
	CLOSE	(UNIT=3)	!COULD NOT FIND BEFORE TUMBLES
C
2500	CONTINUE
C
	EFLAG=0
C
	IF (BT14X .LT. LBT14X)THEN
		CHEM='%BT1/4'
		WRITE	(6,2055)CHEM
		EFLAG=1
		WRITE	(6,1385)PRINTON		!LIST GOES TO PRINTER
C
		WRITE	(6,5555)FF,MMX,DDX,YYX,WBILLX,CHEM
C
		WRITE	(6,1385)PRINTOF		!RETURN TO SCREEN
C
	END IF
C
	IF (AT14X .LT. LAT14X)THEN
		CHEM='%AT1/4'
		WRITE	(6,2055)CHEM
		EFLAG=1
		WRITE	(6,1385)PRINTON		!LIST GOES TO PRINTER
C
		WRITE	(6,5555)FF,MMX,DDX,YYX,WBILLX,CHEM
C
		WRITE	(6,1385)PRINTOF		!RETURN TO SCREEN
C
	END IF
C
	IF (COMPX .LT. LLCOMPX)THEN
		CHEM='COMPS#'
		WRITE	(6,2055)CHEM
		EFLAG=1
	END IF
C
	IF (EFLAG .EQ. 1)THEN	!IF WE HAVE FOUND AN ERROR
		WRITE	(6,2060)
		READ	(6,150)LEN,OPTX
C
		IF (LEN .EQ. 0)GOTO 99999	!IF NO INPUT SHUT OFF
C
		IF (OPTX .EQ. 'Y')GOTO 2510	!CONTINUE WITH ERROR
C
		IF (OPTX .EQ. 'N')GOTO 2020     !ASK FOR NEW INPUT
C
	END IF
C
2510	CONTINUE
C
	CUT3(1)=0
C
	WRITE	(1)DATETIME,WBILLX,PLANTX,NUMX,CARSX,
	1	TONSX,IRONX,SILX,MOISTX,PHOSX,MNX,ALUMX,CAOX,MGOX,BAX,
	1	BT12X,BT14X,BT4MX,AT14X,AT28MX,COMPX,LCOMPX,BAL,OCARS,UCARS,
	1	CUT1,CUT2,CUT3,CUT4,SPLITC,SPLITX,FLAGS,EXTRA,CHECKNX
C
	GOTO 2000	!GO INPUT ANOTHER TRAIN
C
99999 	CONTINUE
C
	CLOSE	(UNIT=1)
C
	CALL	LIB$SPAWN('COPY OREM:TRAINS.DAT OREM:TRAINS.RJM')
	CALL	LIB$SPAWN('COPY OREM:TRAINS.DAT OREM:TRAINS.RPT')
C
	CALL	EXIT
	END
C
	SUBROUTINE	CLRSCREEN
C
	CALL	LIB$ERASE_PAGE(1,1)
	CALL	LIB$SET_CURSOR(1,1)
C
	RETURN
	END
C
	SUBROUTINE	READKEYBD(KEYBD,WORDS,CHR)
C
	IMPLICIT NONE
C
	CHARACTER*100	KEYBD
	CHARACTER*12	WORDS(13)
	INTEGER*4	CHR(13)
C
	INTEGER*4	I,J,K,L
C
	DO 5000	I=1,13
		WORDS(I)='            '
		CHR(I)=0
5000	CONTINUE
C
	J=1
	K=1
C
	DO 6000 I=1,100
		IF (KEYBD(I:I) .EQ. ' ')GOTO 6000
		IF ((KEYBD(I:I) .EQ. '-').OR.(KEYBD(I:I) .EQ. ','))THEN
			J=J+1
			K=1
		ELSE
			WORDS(J)(K:K)=KEYBD(I:I)
			K=K+1
			CHR(J)=CHR(J)+1
		END IF
6000	CONTINUE
	RETURN
	END


